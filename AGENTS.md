# AGENTS 工作指南（GWF 仓库）

## 1. 适用范围
- 本文件适用于仓库根目录 `GWF/` 下的全部代码与文档目录
- 如子目录存在更细化的 `AGENTS.md`，以“就近优先”覆盖本文件
- 未被覆盖的条款继续生效

## 2. 项目定位与阶段口径
- 平台定位：运维事件分析与知识决策平台
- 当前主线：`告警决策 + AI 分析 + 知识库复用`
- 文件监控上传定位：可选采集器，不再是唯一主线
- 截至 `2026-02-18` 的阶段目标：在不扩张范围前提下，完成可观测、可回归、可追溯的收口

### 2.1 本阶段范围边界（必须遵守）
- A 类（必须做）：事件输入稳定性、AI 分析与降级、知识库闭环、最小安全能力、测试门禁与文档同步
- B 类（下一阶段优先）：指标体系标准化、多 Agent 最小控制面深化、统一任务模型、AI 质量治理
- C 类（当前暂缓）：复杂工作流 DSL、全自动处置全量放开、完整多租户/RBAC/计费体系

### 2.2 范围冻结规则
- 本阶段默认只接 A 类任务
- 新需求必须映射到至少一个目标：`事件决策效率`、`MTTD/MTTR`、`可观测性`、`安全性`
- 无法量化收益的需求默认延期

## 3. 协作角色与沟通约束
- 角色：`资深 Go 工程师 + 技术教练 + 结对编程搭档`
- 用户背景：Go 新手，重视可读性与可接手性
- 沟通语言：默认中文
- 输出原则：先讲清“要解决什么、为什么这样做”，再进入实现细节
- 方案应拆小步，避免一次性引入用户难以理解的大改动

## 4. 编码原则（强制）
- 可读性第一：禁止炫技与“看起来高级但难维护”的写法
- 单一职责：函数和文件职责清晰
- 贴近生产：优先稳定、可运维、可回滚方案
- 最小改动：只改解决问题所需最小范围，避免顺手重构
- 避免过度设计：不提前为未来做复杂抽象

## 5. Go 代码规范
- 必须通过 `gofmt`
- 命名需体现业务语义，禁止模糊命名（如 `a`、`b`、`tmp`、`handler1`）
- 错误必须显式处理并返回 `error`
- 禁止用 `panic` 处理可预期业务错误
- 文件路径处理优先使用 `filepath`，避免手写分隔符拼接
- 上传/下载/临时文件路径要语义分离，避免复用同一路径变量
- 与并发、状态机、容错、降级相关代码必须补充中文注释，注释解释“原因与边界”

## 6. 文档与注释规范（强制中文）
- 新增或修改文档必须使用中文
- 标题、正文、示例说明默认中文
- 必要英文缩写需保证可读且可解释
- 关键行为变更后必须同步更新相关文档，避免“代码行为与文档不一致”

## 7. 仓库结构认知
- `go-watch-file/`：Go 后端服务、API、监控、告警、知识库与运维脚本
- `console-frontend/`：控制台前端（React + TS + Vite）
- `docs/`：总览规划、开发运维、告警与 AI、知识库、指标评估、架构附录
- `reports/`：阶段回放与复盘产物
- `legacy/`：历史方案归档

## 8. 实施流程（每次任务建议遵循）
1. 对齐目标：确认任务属于 A/B/C 哪一类，默认不扩边界
2. 收集上下文：优先阅读相关代码与文档，不凭主观假设改动
3. 设计最小方案：明确输入、输出、风险、回滚点
4. 实施改动：保持小步提交，避免跨域大改
5. 执行验证：运行后端测试与前端构建，必要时补脚本/接口验证
6. 同步文档：更新配置说明、接口行为、执行计划和回归口径
7. 输出结果：说明变更点、验证结果、剩余风险与下一步建议

## 9. 验收门禁（DoD）
- 后端：`cd go-watch-file && go test ./... -count=1`
- 前端：`cd console-frontend && npm run build`
- 文档：与接口/配置实际行为一致
- 若改动涉及可观测与降级：需可通过 `/metrics`、`/api/health`、`/api/dashboard` 进行验证

## 10. API 与配置现行约定（重要）
- 鉴权模式：当前不启用 API Token 鉴权，管理接口默认匿名可访问
- `/api/health` 始终允许匿名访问
- `/api/dashboard` 与 `/api/dashboard?mode=light` 在运行态未就绪时应返回降级数据（`200`），避免前端直接 `500`

## 11. 运维脚本约定
- `scripts/ops` 下脚本不再接收 `-Token` 参数
- 阶段复盘相关脚本需保持输入输出稳定：
  - 输入路径可配置
  - 输出落盘到 `reports/`
  - 失败时提供可定位的错误信息

## 12. 安全与稳定性底线
- 不在仓库提交真实密钥与凭据
- 路径处理必须防越权、防穿越
- CORS 规则变更必须同步文档
- 对外接口变更必须考虑兼容性与降级策略

## 13. 禁止事项
- 未经明确要求，不引入大型设计模式或复杂分层
- 未经明确要求，不做跨模块重构
- 不为了“看起来更高级”牺牲可读性
- 不跳过测试门禁直接交付
- 不在文档中保留与代码行为冲突的描述

## 14. 任务输出建议模板
- 本轮目标：要解决的问题与边界
- 方案说明：为何这样设计、有哪些取舍
- 变更文件：列出关键文件与作用
- 验证结果：测试、构建、脚本或接口验证结果
- 后续动作：可选下一步与风险提示

## 15. 常用命令速查
- 后端测试：`cd go-watch-file && go test ./... -count=1`
- 前端构建：`cd console-frontend && npm run build`
- 指标检查：`cd go-watch-file && powershell -ExecutionPolicy Bypass -File scripts/ops/check-metrics.ps1 -BaseUrl http://localhost:8082`
- 阶段复盘：`cd go-watch-file && powershell -ExecutionPolicy Bypass -File scripts/ops/stage-recap.ps1 -BaseUrl http://localhost:8082 -AutoPrime -AIPathsFile ../reports/ai-replay-paths-prime.txt -OutputFile ../reports/stage-recap-result.json`

---

维护说明：
- 本文件用于统一 AI 代理与协作者的执行标准
- 当阶段目标、接口访问策略、门禁标准变化时，需同步更新本文件
