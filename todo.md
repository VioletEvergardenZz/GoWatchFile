# 通用文件监控管理系统 - Roadmap / TODO（按模块蓝图对齐）

> 目标：依照大纲模块，将系统演进为通用“文件监控 + 上传 + 路由/编排 + 可视化”平台。先稳固 Agent，再补齐控制面、路由编排、可视化与分析。

## 当前已落地（基于现有代码）
- 递归目录监听 + 新增子目录自动发现（fsnotify）。
- 多后缀过滤与写入完成判定（静默窗口）。
- 内存队列 + worker pool 并发上传至 S3。
- 控制台 API：dashboard/自动上传开关/手动上传/file-log/config/health/alerts/alert-config。
- 前端控制台联动：目录树、上传记录、队列趋势、日志 Tail、配置更新、告警控制台。
- 系统资源控制台：CPU/内存/磁盘/进程概览（可配置开启）。
- 文件内容检索：file-log 支持关键词检索。
- 钉钉机器人通知（可选）。
- 告警决策模块：日志轮询、规则匹配、抑制与异常升级。

## 阶段 0：基线整理
- [x] 清理/迁移旧版 OOM 资料，统一命名。  
- [x] 配置模板完善：`.env.example`、`config.yaml` 注释与示例。  
- [x] README/开发指南/FAQ 补全。  
- [x] 控制台 API 与前端联调基础链路。  
- [ ] 基础验证：`go test ./...`，单机端到端上传 + 通知。  

## 阶段 1：Agent 采集与上传传输
- [x] 文件匹配：多后缀。  
- [ ] 可靠性：失败重试（上限/退避）、断点续传/etag 校验、临时文件过滤。  
- [x] 并发与背压：工作池 + 队列（内存）。
- [ ] 并发与背压：队列饱和阈值/告警，限流/熔断。
- [x] 静默时间可调（`silence`/`SILENCE_WINDOW`）。
- [ ] 指标与日志：Prometheus（事件速率、队列长度、上传耗时、错误码），结构化日志。  
- [x] 配置体验：启动校验与运行时更新（仅 watchDir/fileExt/silence/workers/queue）。  
- [ ] 测试：pathutil/upload/watcher/s3 mock；端到端上传 + 通知。  

## 阶段 2：控制与配置（多 Agent 管理）
- [ ] 模型：FileSource、FileEvent、Task(Action)、Notification。  
- [ ] Agent 管理：注册/心跳、主机组/应用分组，配置中心拉/推，版本与灰度。  
- [ ] API：REST/gRPC（状态查询、重试/取消、手动触发、Agent 状态）。  
- [ ] 凭证与安全：S3/通知 Secret 管理，最小权限示例。  
- [ ] 基础仪表 API：成功率、失败分布、滞留统计。  
- [ ] 审计：操作日志与鉴权（Token/Bearer → 后续 RBAC）。  

## 阶段 3：文件路由与处理编排
- [ ] Action 抽象：HTTP Webhook、消息队列、脚本、本地/远端处理器。  
- [ ] 路由规则：路径/标签/大小/来源/时间窗口/内容标签 → 多桶/多队列。  
- [ ] 编排：顺序/并行、超时/取消、最大并发；可插拔规则/工作流引擎。  
- [ ] 幂等与补偿：重试策略、去重键（hash 或 路径+mtime）、回退动作。  
- [ ] 大文件策略：分片/断点续传/合并校验，分阶段触发后续动作。  

## 阶段 4：存储与索引
- [ ] 元数据落库：file_sources/file_events/tasks/notifications（状态机）。  
- [ ] 查询与检索：按应用/路径/状态/时间范围过滤，分页。  
- [ ] 内容索引（可选）：日志摘要/文件名索引，全文检索能力评估。  
- [ ] 数据生命周期：清理与归档策略，审计数据留存。  

## 阶段 5：可视化界面与告警
- [ ] Web 控制台增强：失败/滞留列表、任务详情与重试入口。  
- [ ] 日志可视化：全文检索/关键词搜索，对接 ELK/Loki/Graylog 或内置轻量视图。  
- [ ] 告警策略：上传失败率、处理超时、Agent 离线、SLA 未达；渠道（邮件/钉钉/Webhook），告警聚合/抑制。  
- [ ] Agent 状态面板：心跳、版本、配置、最近错误。  

## 阶段 6：分析报表与 SLA
- [ ] 报表：日/周上传量、大小分布、吞吐/耗时、失败率、滞留数。  
- [ ] 趋势与容量：容量/成本预测，存储生命周期与分级策略建议。  
- [ ] 异常检测：量级突增/失败率突升自动提醒。  
- [ ] SLA/SLO：定义、达成率计算、违规告警。  

## 阶段 7：发布与运维
- [ ] 交付资产：Docker/Helm/Compose 样例，挂载配置与凭证。  
- [ ] 多环境模板：dev/stage/prod，出网/离线/代理场景。  
- [ ] 升级策略：滚动/灰度、兼容性校验、回滚预案。  
- [ ] 压测与容量：大文件/高频事件压测，阈值与告警建议。  
- [ ] 文档：API、部署指南、运维手册、故障排查与 Runbook。  
- [ ] 安全合规：渗透/安全扫描、密钥轮换流程、最小权限示例策略。  

## 数据与配置草案
- **Agent 配置**：watch_dir、file_ext（多值）、ignore 列表、静默时间、upload_workers、upload_queue_size、S3（bucket/ak/sk/endpoint/region/force_path_style/disable_ssl）、通知（钉钉等）、日志。  
- **表设计雏形**：  
  - `file_sources`：来源目录/租户/标签。  
  - `file_events`：事件明细（路径、大小、hash、产生时间、状态）。  
  - `tasks`：处理任务（Action、状态、重试计数、耗时）。  
  - `notifications`：通知流水与结果。  
  - `agents`：节点/版本/心跳/标签。  
  - `routing_rules`：规则定义与版本。  

## 风险与注意事项
- 存储兼容性：不同 S3 实现的 path-style/SSL/分段要求。  
- 大文件与频繁写入：静默时间、分段/断点策略，避免半文件。  
- 网络与认证：内网/外网访问、代理、凭证刷新与密钥管理。  
- 安全：目录穿越防护、凭证隔离、Webhook 鉴权、最小权限访问。  
- 观测缺口：完成指标/日志聚合前需手动检查上传队列与错误日志。  
