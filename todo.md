# 运维事件分析与知识决策平台 - Roadmap / TODO（按模块蓝图对齐）

> 目标：将系统演进为“事件采集适配 + 告警决策 + AI 运维分析 + 知识复用 + 路由编排”平台。文件监控上传作为可选输入适配器持续维护。

## 定位声明（当前口径）
- 主线能力：告警决策闭环 + AI 分析闭环 + 知识库复用闭环。
- 文件监控上传：输入适配器之一，不再是唯一主线。
- 后续策略：根据新需求可调整输入侧重点，但保持可观测与可回滚底线。

## 当前已落地（基于现有代码）
- 文件输入适配器：递归目录监听 + 新增子目录自动发现（fsnotify）。
- 文件输入治理：多后缀过滤、写入完成判定（静默窗口）、临时文件后缀过滤（如 .tmp/.part/.crdownload）。
- 文件上传链路：内存队列 + worker pool 并发上传至 OSS。
- 上传可靠性：失败重试（可开关/可配置间隔）。
- 控制台 API：dashboard/自动上传开关/手动上传/file-log/ai-log-summary/config/health/alerts/alert-config/alert-rules/system。
- 前端控制台联动：目录树、上传记录、队列趋势、日志 Tail、AI 总结、配置更新、告警控制台。
- 系统资源控制台：CPU/内存/磁盘/进程概览（可配置开启）。
- 文件内容检索：file-log 支持关键词检索。
- AI 日志分析：可对选中文件进行 AI 总结（需启用配置）。
- 钉钉机器人通知（可选）。
- 告警决策模块：日志轮询、规则匹配、抑制与异常升级。

## 阶段优先级校准（当前决策）
- **P0（当前 1~2 个迭代）**：告警决策稳定性、AI 可用性治理、知识库运营指标收口（上传链路做稳定维护）。
- **P1（随后 2~4 个迭代）**：多 Agent 控制面 MVP、事件与任务模型落地。
- **P2（中期）**：路由编排、SLA 报表、AIOps 异常检测与根因关联。

## 下一步执行计划（滚动 2~4 周）
- 计划文档：`docs/01-总览规划/下一阶段执行计划.md`
- [-] 完成 `/metrics` 采集接入与阈值告警配置（队列/失败率/AI 降级率）
- [-] 完成上传链路压测与故障注入报告（OSS 抖动/网络超时/队列饱和）
- [-] 完成 AI 回放样例集与降级结果验收（结构一致性 + 错误分类）
- [-] 完成知识库命中率/引用率阶段复盘与改进清单

## 阶段 0：基线整理
- [x] 清理/迁移旧版 OOM 资料，统一命名。  
- [x] 配置模板完善：`.env.example`、`config.yaml` 注释与示例。  
- [x] README/开发指南/FAQ 补全。  
- [x] 控制台 API 与前端联调基础链路。  
- [ ] 基础验证：`go test ./...`，单机端到端上传 + 通知。  
- [ ] AI 基线验证：固定样例日志回放，确认 AI 结果结构稳定（summary/severity/suggestions）。

## 阶段 1：输入适配与上传链路维护
- [x] 文件匹配：多后缀。  
- [x] 可靠性：上传失败重试（可开关/可配置间隔）。  
- [x] 可靠性：临时文件过滤（常见临时后缀）。  
- [ ] 可靠性：重试策略完善（上限/退避）、断点续传/etag 校验。  
- [x] 并发与背压：工作池 + 队列（内存）。
- [x] 并发与背压：队列饱和阈值/告警，限流/熔断。
- [x] 静默时间可调（`silence`）。
- [x] 指标：Prometheus（事件速率、队列长度、上传耗时、错误码）。  
- [ ] 日志：结构化日志。  
- [x] 配置体验：启动校验与运行时更新（watchDir/fileExt/silence/workers/queue/uploadRetryDelays/uploadRetryEnabled/systemResourceEnabled）。  
- [ ] 测试：pathutil/upload/watcher/oss mock；端到端上传 + 通知。  
- [x] AI 稳定性：AI 请求超时/降级/重试策略与错误分类指标。

## 阶段 2：控制与配置（多 Agent 管理）
- [ ] 模型：FileSource、FileEvent、Task(Action)、Notification。  
- [ ] Agent 管理：注册/心跳、主机组/应用分组，配置中心拉/推，版本与灰度。  
- [ ] API：REST/gRPC（状态查询、重试/取消、手动触发、Agent 状态）。  
- [ ] 凭证与安全：OSS/通知 Secret 管理，最小权限示例。  
- [ ] 基础仪表 API：成功率、失败分布、滞留统计。  
- [ ] 审计：操作日志与鉴权（Token/Bearer → 后续 RBAC）。  

## 阶段 3：事件路由与处理编排
- [ ] Action 抽象：HTTP Webhook、消息队列、脚本、本地/远端处理器。  
- [ ] 路由规则：路径/标签/大小/来源/时间窗口/内容标签 → 多桶/多队列。  
- [ ] 编排：顺序/并行、超时/取消、最大并发；可插拔规则/工作流引擎。  
- [ ] 幂等与补偿：重试策略、去重键（hash 或 路径+mtime）、回退动作。  
- [ ] 大文件策略：分片/断点续传/合并校验，分阶段触发后续动作。  

## 阶段 4：存储与索引
- [ ] 元数据落库：file_sources/file_events/tasks/notifications（状态机）。  
- [ ] 查询与检索：按应用/路径/状态/时间范围过滤，分页。  
- [ ] 内容索引（可选）：日志摘要/文件名索引，全文检索能力评估。  
- [ ] 数据生命周期：清理与归档策略，审计数据留存。  

## 阶段 5：可视化界面与告警
- [ ] Web 控制台增强：失败/滞留列表、任务详情与重试入口。  
- [ ] 日志可视化：全文检索/关键词搜索，对接 ELK/Loki/Graylog 或内置轻量视图。  
- [ ] 告警策略：上传失败率、处理超时、Agent 离线、SLA 未达；渠道（邮件/钉钉/Webhook），告警聚合/抑制。  
- [ ] Agent 状态面板：心跳、版本、配置、最近错误。  
- [ ] 告警 AI 面板：对决策记录展示 AI 摘要、原因与建议动作。

## 阶段 6：分析报表与 SLA
- [ ] 报表：日/周上传量、大小分布、吞吐/耗时、失败率、滞留数。  
- [ ] 趋势与容量：容量/成本预测，存储生命周期与分级策略建议。  
- [ ] 异常检测：量级突增/失败率突升自动提醒。  
- [ ] SLA/SLO：定义、达成率计算、违规告警。  
- [ ] 根因关联：结合配置变更、版本变更、下游错误码做关联分析。

## 阶段 7：发布与运维
- [ ] 交付资产：Docker/Helm/Compose 样例，挂载配置与凭证。  
- [ ] 多环境模板：dev/stage/prod，出网/离线/代理场景。  
- [ ] 升级策略：滚动/灰度、兼容性校验、回滚预案。  
- [ ] 压测与容量：大文件/高频事件压测，阈值与告警建议。  
- [ ] 文档：API、部署指南、运维手册、故障排查与 Runbook。  
- [ ] 安全合规：渗透/安全扫描、密钥轮换流程、最小权限示例策略。  

## 数据与配置草案
- **Agent 配置**：watch_dir、watch_exclude、file_ext（多值）、ignore 列表、静默时间、upload_workers、upload_queue_size、upload_retry_enabled/upload_retry_delays、OSS（bucket/ak/sk/endpoint/region/force_path_style/disable_ssl）、通知（钉钉等）、日志。  
- **表设计雏形**：  
  - `file_sources`：来源目录/租户/标签。  
  - `file_events`：事件明细（路径、大小、hash、产生时间、状态）。  
  - `tasks`：处理任务（Action、状态、重试计数、耗时）。  
  - `notifications`：通知流水与结果。  
  - `agents`：节点/版本/心跳/标签。  
  - `routing_rules`：规则定义与版本。  

## 风险与注意事项
- 存储兼容性：不同 OSS 实现的 path-style/SSL/分段要求。  
- 大文件与频繁写入：静默时间、分段/断点策略，避免半文件。  
- 网络与认证：内网/外网访问、代理、凭证刷新与密钥管理。  
- 安全：目录穿越防护、凭证隔离、Webhook 鉴权、最小权限访问。  
- 观测缺口：完成指标/日志聚合前需手动检查上传队列与错误日志。  

