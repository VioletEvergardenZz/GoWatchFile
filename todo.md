# 通用文件监控管理系统 - 开发计划

> 目标：把原有的 Java 堆转储链路重构为通用的“文件监控 + 上传 + 触发处理”平台，先稳固 Agent，再补齐控制面、策略编排和可观测性。

## 阶段 0：基线整理（1-2 天）
- [x] 清理/迁移旧版 OOM 相关文档与示例，统一命名为通用文件监控。  
- [x] 统一配置模板：`.env.example`、`config.yaml` 注释，补充通用示例（log/txt/zip 等）。  
- [x] 补全 README/开发指南与常见问题。  
- [ ] 基础验证：`go test ./...`、单机端到端验证上传 + Jenkins 触发 + 通知（待环境执行）。  

## 阶段 1：Agent 强化（go-watch-file，1-2 周）
- [ ] 文件匹配增强：支持多后缀、忽略目录/文件、按子目录分流策略。  
- [ ] 可靠性：失败重试（上限/退避）、断点续传/完整性校验（大小/etag）、临时文件过滤。  
- [ ] 并发与背压：队列饱和告警、限流/熔断策略、可配置静默时间。  
- [ ] 可观测性：暴露 Prometheus 指标（事件速率、队列长度、上传耗时、错误码分布）。  
- [ ] 配置热更新/重新加载（可选），启动参数校验与错误提示优化。  
- [ ] 单元/集成测试补齐（pathutil、upload、watcher、jenkins/s3 mock）。  

## 阶段 2：控制面 & API（2-3 周）
- [ ] 领域模型设计：FileSource、FileEvent、Task（上传/处理）、Action、Notification。  
- [ ] 数据持久化：事件/任务/通知流水表；状态机（待处理/处理中/完成/失败/重试中）。  
- [ ] REST/gRPC API：文件状态查询、重试/取消、手动触发处理、Agent 注册与心跳。  
- [ ] 认证与鉴权：Token/Bearer 基础校验，后续扩展 RBAC。  
- [ ] 简易 Dashboard API：关键指标/速率/失败分布。  

## 阶段 3：处理链路与插件（2-3 周）
- [ ] Action 抽象：Jenkins、HTTP Webhook、消息队列、脚本执行、本地/远端处理器。  
- [ ] 规则路由：按路径/标签/大小/来源/时间窗口选择 Action 组合，支持多路并行。  
- [ ] 幂等与补偿：重试策略、去重键（文件 hash/路径+mtime）、回退动作。  
- [ ] 任务编排：顺序/并行、超时/取消、最大并发。  

## 阶段 4：Web 控制台（3-4 周）
- [ ] 框架选型（Vue/React），建立基础布局与组件库。  
- [ ] 页面：总览（指标/告警）、文件列表与时间线、任务详情、通知记录、配置管理。  
- [ ] 实时刷新/长轮询或 WebSocket，状态筛选与搜索。  
- [ ] 权限与审计：操作日志、按角色控制动作权限。  

## 阶段 5：可观测与运维（1-2 周）
- [ ] 指标面板：队列/速率/耗时/错误分布，Agent 在线状态。  
- [ ] 日志聚合：结构化日志、TraceID/RequestID 贯通。  
- [ ] 告警规则：上传失败率、处理超时、Agent 离线、存储/网络异常。  
- [ ] 压测与容量：大文件/高频事件压测，容量预估与报警阈值建议。  

## 阶段 6：发布与部署（1-2 周）
- [ ] Docker/Helm/Compose 示例，支持挂载配置与凭证。  
- [ ] 多环境配置模板（dev/stage/prod），出网/内网场景说明。  
- [ ] 升级策略：滚动升级/灰度、兼容性校验、回滚预案。  
- [ ] 文档：API 文档、部署指南、运维手册、故障排查。  

## 数据与配置草案
- **配置（Agent）**：watch_dir、file_ext 多值、ignore 列表、静默时间、upload_workers、upload_queue_size、S3（bucket/ak/sk/endpoint/region/force_path_style/disable_ssl）、Jenkins（host/user/password/job）、通知（企微/钉钉）、日志。  
- **表设计雏形**：  
  - `file_sources`：来源目录/租户/标签。  
  - `file_events`：事件明细（路径、大小、hash、产生时间、状态）。  
  - `tasks`：处理任务（Action、状态、重试计数、耗时）。  
  - `notifications`：通知流水与结果。  

## 风险与注意事项
- 存储兼容性：不同 S3 实现的 path-style/SSL 要求、分段上传需求。  
- 大文件与频繁写入：静默时间、分段/断点策略，避免半文件。  
- 网络与认证：内网/外网访问、代理、凭证刷新与密钥管理。  
- 安全：目录穿越防护、凭证隔离、Webhook/Jenkins 鉴权、最小权限访问。  
