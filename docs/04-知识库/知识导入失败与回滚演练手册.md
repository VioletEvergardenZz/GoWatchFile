# 知识导入失败与回滚演练手册

> 文档状态：兼容保留  
> 更新时间：2026-02-24  
> 适用范围：`/api/kb/import/docs`、`/api/kb/articles/{id}/rollback`、知识库 SQLite 数据恢复

## 1. 目标

补齐知识库“失败路径”演练，确保值班场景可以稳定回答：

1. 导入失败后如何定位原因并恢复
2. 条目发布错误后如何回滚到正确版本
3. 数据异常时如何执行数据级回滚

## 2. 前置准备

1. 服务可访问：`http://localhost:8082`
2. 已准备测试文档目录（建议专用测试目录，避免污染正式文档）
3. 备份知识库文件：

```powershell
Copy-Item go-watch-file\data\kb\knowledge.db go-watch-file\data\kb\knowledge.db.bak-$(Get-Date -Format yyyyMMddHHmmss)
```

4. 执行基础门禁：

```powershell
cd go-watch-file
go test ./...
```

## 3. 失败场景演练

## 场景 A：导入路径错误

### 操作

1. 在控制台执行“导入 docs”，输入不存在目录
2. 或直接调用导入接口并传入错误路径

### 预期

1. 导入结果返回失败信息，能定位到路径问题
2. 服务不崩溃，已有知识条目不受影响

### 处置

1. 修正导入路径
2. 重新执行导入并确认 `新增/更新/跳过` 统计恢复正常

## 场景 B：条目发布后内容错误（应用级回滚）

### 操作

1. 选择一条已发布条目，连续编辑两次生成多版本
2. 模拟错误内容发布后，通过回滚接口回退

```json
POST /api/kb/articles/{id}/rollback
{
  "targetVersion": 2,
  "operator": "sre",
  "comment": "rollback bad content"
}
```

### 预期

1. 回滚成功后生成新版本，内容恢复到目标版本快照
2. 条目状态与检索可用性保持正常

## 场景 C：数据库异常（数据级回滚）

### 操作

1. 停止服务
2. 使用备份覆盖当前 `knowledge.db`
3. 启动服务并执行接口验证

```powershell
curl http://localhost:8082/api/kb/articles
```

### 预期

1. 服务可正常启动
2. 核心接口可用（列表/检索/问答）
3. 明确记录“备份时点之后数据会丢失”

## 4. 演练后核对

1. 核对导入统计是否回归正常
2. 核对检索与问答是否可用
3. 核对回滚条目版本链是否完整
4. 记录演练结论并归档到 `reports/`

## 5. 演练记录模板

| 场景 | 执行人 | 日期 | 结果(P/F) | 根因 | 处置动作 | 备注 |
| --- | --- | --- | --- | --- | --- | --- |
| A 路径错误 |  |  |  |  |  |  |
| B 应用级回滚 |  |  |  |  |  |  |
| C 数据级回滚 |  |  |  |  |  |  |

## 6. 关联文档

- `docs/04-知识库/知识库端到端验收.md`
- `docs/04-知识库/知识库迁移与回滚.md`
- `docs/04-路线图与计划/TODO.md`

