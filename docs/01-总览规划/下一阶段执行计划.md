# 下一阶段执行计划（2026-02-17）

> 目标：在不扩张范围的前提下，完成“事件分析可观测 + 知识库可运营 + 文档可追溯”三条主线收口。

> 平台定位（当前口径）：运维事件分析与知识决策平台，文件监控上传为可选采集器。

## 0. 执行状态快照（已启动）

| 工作项 | 状态 | 输出物 |
| --- | --- | --- |
| 监控指标字典 v1 | 已完成 | `docs/05-指标与评估/监控指标字典-v1.md` |
| 告警阈值草案 v0.1 | 已完成 | `docs/05-指标与评估/指标告警阈值草案-v0.1.md` |
| 指标巡检脚本 | 已完成 | `go-watch-file/scripts/ops/check-metrics.ps1` |
| 上传压测脚本 | 已完成 | `go-watch-file/scripts/ops/upload-stress.ps1` |
| AI 回放脚本与手册 | 已完成 | `go-watch-file/scripts/ops/ai-replay.ps1`、`docs/03-告警与AI/AI回放验收手册.md` |
| 上传可靠性演练手册 | 已完成 | `docs/03-告警与AI/上传可靠性演练手册.md` |
| 阶段回归报告模板 | 已完成 | `docs/05-指标与评估/阶段回归报告模板-v1.md` |
| 知识库问答引用率门禁 | 已完成 | `go-watch-file/cmd/kb-eval/main.go`（`citation` 子命令） |
| 知识库指标看板 + 问答降级可视化 | 已完成 | `console-frontend/src/KnowledgeConsole.tsx`、`go-watch-file/internal/api/kb_handlers.go` |
| 真实环境演练报告 | 已完成（未通过） | `docs/05-指标与评估/阶段回归报告-2026-02-17.md` |

## 1. 本阶段范围（2~4 周）

### 1.1 必做（P0）
- 事件输入链路稳定性收口：覆盖文件上传、手动/API 输入路径的高压一致性验证。
- 指标落地收口：对接 `/metrics` 到监控系统，形成事件分析与决策闭环看板。
- AI 稳定性收口：覆盖 AI 成功/重试/降级/失败分类的回归样例
- 文档收口：配置、接口、运行手册、FAQ 与实际行为保持一致

### 1.2 优先（P1）
- 知识库运营闭环：复审队列规则、问答引用率监控、告警推荐命中复盘
- 端到端回归：导入 -> 发布 -> 检索 -> 问答 -> 推荐 -> 回滚全链路自动化

### 1.3 本阶段不做
- 多 Agent 完整控制面（跨集群调度、灰度发布、配置中心推拉）
- 路由编排 DSL 与复杂工作流
- 断点续传与分片上传

## 2. 里程碑进度

### 里程碑 A（第 1 周）
- 状态：`85%`
- 已完成：
  - 监控指标字典 v1
  - `/metrics` 告警阈值草案
  - 文档差异项（执行文档）补齐
- 待完成：
  - 将阈值草案同步到实际告警平台并开启观察模式

### 里程碑 B（第 2 周）
- 状态：`75%`
- 已完成：
  - 上传压测与 AI 回放自动化脚本
  - 可靠性演练手册与 AI 回放手册
- 待完成：
  - 修复回归报告中的阻断项（上传链路计数、AI 降级率、知识库命中/引用门禁）

### 里程碑 C（第 3~4 周）
- 状态：`75%`
- 已完成：
  - 知识库评估工具补充引用率门禁（`kb-eval citation`）
  - 控制面 MVP 设计草案（`docs/01-总览规划/控制面MVP设计草案.md`）
  - 控制面首批接口落地（Agent register/heartbeat/list 与 Task create/list/get/cancel/retry）
  - 控制面 SQLite 持久化与启动恢复（agents/tasks）
- 待完成：
  - 命中率/引用率/MTTD 的实测复盘结果
  - 控制面任务生命周期回放与指标门禁（online/backlog/timeout）

## 3. 可交付物清单

1. 指标字典与告警阈值文档
2. 压测与故障演练报告
3. AI 回放与降级验证报告
4. 知识库运营复盘（命中率、引用率、MTTD 对比）
5. 更新后的部署/开发/运维文档

## 4. 验收标准（DoD）

1. 后端 `go test ./...` 全通过
2. 前端 `npm run build` 全通过
3. `/metrics` 指标可被抓取，关键指标有稳定数值
4. AI 分析失败时可降级返回且 `meta` 字段完整
5. 文档与接口/配置行为一致，无明显冲突项

## 5. 主要风险与应对

- 风险：监控阈值不合理导致误报
  - 应对：先以观察模式上线 1 周，再调阈值
- 风险：AI 外部服务波动导致分析质量不稳定
  - 应对：固定回放样例 + 降级结果模板 + 错误分类看板
- 风险：文档更新滞后导致执行偏差
  - 应对：每次功能合并必须同步文档 PR 清单

## 6. 下一阶段入口

- 可靠性与观测：`todo.md`（阶段 1）
- 知识库路线：`docs/04-知识库/运维知识库实施清单.md`
- 全局范围控制：`docs/01-总览规划/MVP范围控制.md`


## 7. 2026-02-17 进展更新（里程碑 B）
- 已完成：修复 Windows 路径穿越场景下上传链路阻断问题
- 当前状态：
  - 压测回放下上传链路计数已开始增长
  - `gwf_file_events_total` 与上传失败/重试计数不再固定为 0
- 里程碑 B 剩余阻断项：
  - AI 降级率仍高于目标（演练配置使用了不可达 AI 端点）
  - 知识库命中率与引用率门禁仍未完全通过

## 8. 2026-02-17 进展更新（知识库门禁）
- 已完成：通过兜底分词打分修复知识库检索/问答门禁
- 验证结果：
  - `kb-eval hitrate`: `20/20 = 100%`
  - `kb-eval citation`: `20/20 = 100%`
- 当前阶段剩余主要阻断项：
  - AI 降级率门禁仍待关闭（需要可达 AI 端点并重新回放）

## 9. 2026-02-17 进展更新（AI 门禁闭环）
- 已完成：
  - 使用可达的本地 OpenAI 兼容端点重跑 `ai-replay.ps1`
  - 复核 `/metrics` 快照与 AI 结果计数
- 验证结果：
  - `ai-replay`: `total=3 success=3 degraded=0 degradedRatio=0.00`
  - `gwf_ai_log_summary_total{outcome="success"} = 3`
  - `gwf_ai_log_summary_total{outcome="degraded"} = 0`
  - `gwf_ai_log_summary_retry_total = 0`
- 里程碑 B 状态：
  - 上传链路阻断项：已关闭
  - 知识库命中/引用阻断项：已关闭
  - AI 降级率阻断项：已关闭
  - 总体进度：`100%`

## 10. 2026-02-17 进展更新（里程碑 C 启动）
- 已完成：
  - 新增控制面 MVP 设计草案，覆盖范围边界、v1 数据模型、API 草案、指标与 DoD
- 输出：
  - `docs/01-总览规划/控制面MVP设计草案.md`
- 下一关注点：
  - 运行任务生命周期指标回放验证，并将控制面指标接入 `/metrics`

## 11. 2026-02-17 进展更新（控制面 API v1）
- 已完成：
  - 新增控制面接口：
    - `POST/GET /api/control/agents`
    - `GET /api/control/agents/{id}`
    - `POST /api/control/agents/{id}/heartbeat`
    - `POST /api/control/agents/{id}/drain`
    - `POST/GET /api/control/tasks`
    - `GET /api/control/tasks/{id}`
    - `POST /api/control/tasks/{id}/cancel`
    - `POST /api/control/tasks/{id}/retry`
  - 补充了 Agent/Task 生命周期 API 测试。
- 代码：
  - `go-watch-file/internal/api/control_handlers.go`
  - `go-watch-file/internal/api/control_handlers_test.go`
  - `go-watch-file/internal/api/server.go`
- 验证：
  - `cd go-watch-file && go test ./internal/api -count=1` 通过
  - `cd go-watch-file && go test ./... -count=1` 通过

## 12. 2026-02-17 进展更新（控制面存储持久化）
- 已完成：
  - 新增基于 SQLite 的控制面存储，支持 agents/tasks 启动快照恢复
  - 新增持久化测试与恢复后序列连续性测试
- 代码：
  - `go-watch-file/internal/api/control_store.go`
  - `go-watch-file/internal/api/control_store_test.go`
  - `go-watch-file/internal/api/control_handlers.go`
  - `go-watch-file/internal/api/server.go`
- 行为：
  - 默认存储路径：`go-watch-file/data/control/control.db`
  - 可选覆盖：环境变量 `CONTROL_DATA_DIR`
  - 存储初始化或加载失败时会回退到内存模式。
- 验证：
  - `cd go-watch-file && go test ./internal/api -count=1` 通过
  - `cd go-watch-file && go test ./... -count=1` 通过

