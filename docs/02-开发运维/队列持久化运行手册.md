# 上传队列持久化运行手册

> 文档状态：兼容保留  
> 校准日期：2026-02-22
> 口径说明：如与主线目录冲突，以 docs/00-文档治理/文档现行状态清单.md 与主线目录文档为准。

## 1. 目标
- 避免服务重启导致上传队列任务丢失
- 在不引入外部中间件的前提下提供最小可用的落盘能力
- 持久化文件损坏时自动降级并保持服务可启动

## 2. 当前实现
- 持久化实现：`go-watch-file/internal/persistqueue/file_queue.go`
- 核心测试：`go-watch-file/internal/persistqueue/file_queue_test.go`
- 运维命令：`go-watch-file/cmd/queue-admin/main.go`

## 3. 配置项
- `upload_queue_persist_enabled`
  - 含义：是否开启上传队列持久化
  - 默认：`false`
  - 生效方式：静态配置，修改后需要重启服务
- `upload_queue_persist_file`
  - 含义：持久化队列文件路径
  - 默认：`logs/upload-queue.json`
  - 生效方式：静态配置，修改后需要重启服务

对应环境变量：
- `UPLOAD_QUEUE_PERSIST_ENABLED`
- `UPLOAD_QUEUE_PERSIST_FILE`

## 4. 运行语义
- 入队前先落盘：任务先写入持久化文件，再写入内存队列
- 上传成功后确认：成功后从持久化队列删除对应任务
- 启动时恢复：服务启动时读取持久化文件恢复未完成任务
- 语义级别：至少一次（At-Least-Once），不保证严格去重

## 5. 损坏降级策略
- 持久化文件不可解析时：
  - 自动备份损坏文件：`<原文件>.corrupt-<timestamp>.bak`
  - 自动重建空队列文件
  - 服务继续启动，避免因坏文件导致整体不可用
- 同时记录错误日志，便于排障

## 6. 运维命令（queue-admin）
在 `go-watch-file` 目录执行：

```bash
# 入队
go run ./cmd/queue-admin -action enqueue -item /tmp/a.log -store logs/upload-queue.json

# 查看队列
go run ./cmd/queue-admin -action peek -store logs/upload-queue.json

# 出队
go run ./cmd/queue-admin -action dequeue -store logs/upload-queue.json

# 清空
go run ./cmd/queue-admin -action reset -store logs/upload-queue.json

# 健康检查（轻量）
go run ./cmd/queue-admin -action check -store logs/upload-queue.json

# 健康检查（JSON，便于脚本解析）
go run ./cmd/queue-admin -action check -format json -store logs/upload-queue.json

# 健康检查（严格模式，降级按失败处理）
go run ./cmd/queue-admin -action check -strict -store logs/upload-queue.json

# 健康检查（JSON 严格模式，降级按失败处理）
go run ./cmd/queue-admin -action check -format json -strict -store logs/upload-queue.json

# 诊断详情（包含文件状态与指标）
go run ./cmd/queue-admin -action doctor -store logs/upload-queue.json

# 诊断详情（JSON，便于脚本解析）
go run ./cmd/queue-admin -action doctor -format json -store logs/upload-queue.json

# 诊断详情（JSON 严格模式，降级按失败处理）
go run ./cmd/queue-admin -action doctor -format json -strict -store logs/upload-queue.json
```

### 6.1 `check` 与 `doctor` 退出码
- `0`：检查通过，状态正常
- `1`：参数错误或不支持的 `action`
- `2`：队列文件不可读或初始化失败；或在 `-strict` 下检测到降级
- `3`：检查通过但处于降级状态（例如检测到损坏降级或持久化写失败）

### 6.2 `check` 的 JSON 输出字段
- `action`：固定为 `check`
- `status`：`ok` 或 `degraded`
- `reason`：降级原因（仅 `degraded` 时存在）
- `store`：队列持久化文件路径
- `queueSize`：当前队列任务数

### 6.3 `doctor` 的 JSON 输出字段
- `action`：固定为 `doctor`
- `status`：`ok` 或 `degraded`
- `reason`：降级原因（仅 `degraded` 时存在）
- `store`：队列持久化文件路径
- `storeExists`：队列文件是否存在
- `storeSizeBytes`：队列文件字节大小
- `storeModTime`：队列文件最近修改时间（UTC RFC3339）
- `queueSize`：当前队列任务数
- `recoveredTotal`：累计恢复任务数
- `corruptFallbackTotal`：累计损坏降级次数
- `persistWriteFailureTotal`：累计持久化写失败次数

### 6.4 健康观测（`/api/health`）
- `persistQueue.enabled`：是否开启持久化队列
- `persistQueue.storeFile`：当前持久化文件路径
- `persistQueue.recoveredTotal`：累计恢复到内存队列的任务数
- `persistQueue.corruptFallbackTotal`：累计损坏降级次数
- `persistQueue.persistWriteFailureTotal`：累计持久化写失败次数

## 7. 现场核对清单
- 重启前入队任务，重启后是否可恢复
- 连续执行 `enqueue/dequeue` 后，队列文件是否可持续解析
- 人工写入损坏 JSON 后，是否生成 `.corrupt-*.bak` 且服务仍可启动
- `queue-admin -action check` 是否可用于脚本化巡检
- `queue-admin -action doctor` 是否输出完整诊断信息

## 8. 当前边界
- 不做严格去重，极端故障场景可能重复处理同一路径
- 不支持断点续传
- 不支持跨实例共享同一持久化文件（默认单实例）
