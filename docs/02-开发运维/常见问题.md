# 常见问题（FAQ）

## 1. 文件创建后没有触发上传
- 确认 `watch_dir` 存在且 Agent 有权限。
- 确认文件后缀与 `file_ext` 匹配（不区分大小写）。
- 写入完成判定需要等待静默窗口（默认约 10 秒）。
- 控制台中该目录是否关闭了“自动上传”。

## 2. 支持多个后缀吗？
支持多个后缀（如 `.log,.txt`），逗号或空格分隔。

## 3. 临时文件没有上传
- 内置忽略临时后缀（如 `.tmp/.part/.crdownload/.download/.swp`）。
- 这是为了避免“未写完的文件”被提前上传。

## 4. 上传队列提示满了或任务堆积
- `upload_queue_size` 是容量上限，不是当前数量。
- 队列满会返回 `upload queue full`，建议增大 `upload_queue_size` 或提高 `upload_workers`。
- 当队列达到 `upload_queue_saturation_threshold` 且开启熔断时，会触发主动限流（`upload queue saturated`）。
- 查看控制台“队列深度/monitor”判断 backlog。

## 5. 上传失败会自动重试吗？
- 默认开启重试，可通过 `upload_retry_enabled` / `upload_retry_delays` / `upload_retry_max_attempts` 调整。
- 若关闭重试，可在控制台触发“手动上传”进行补传。

## 6. 怎么判断是“队列满”还是“熔断限流”？
- `upload queue full`：队列容量已满，无法继续入队。
- `upload queue saturated`：达到饱和阈值后触发熔断限流。
- 可通过 `/api/health` 查看 `queueFullTotal` 与 `queueShedTotal` 区分。
## 7. 上传失败或 Endpoint 报错
- `OSS_ENDPOINT` 可带协议或不带协议（如 `https://oss-cn-hangzhou.aliyuncs.com`）。
- MinIO 场景请设置 `OSS_FORCE_PATH_STYLE=true`，必要时 `OSS_DISABLE_SSL=true`。
- 检查 `OSS_AK/OSS_SK/OSS_BUCKET` 是否有效。

## 8. 自动上传关闭后如何上传？
可在控制台选择文件，点击“手动上传/触发上传”；系统会为该文件执行一次上传。

## 9. 文件 Tail 报错或无内容
- `/api/file-log` 仅支持文本文件（遇到二进制会报错）。
- Tail 只返回最后 512KB / 500 行；传入 `query` 会进入检索模式（默认最多 2000 行）。
- `path` 必须位于 `watch_dir` 配置的任一目录下，否则会被拒绝。

## 10. AI 日志分析提示路径不合法
- `/api/ai/log-summary` 的 `path` 需满足以下任一条件：
  - 位于 `watch_dir` 目录范围内；或
  - 命中 `alert_log_paths` 中配置的日志路径（用于后端错误日志分析）。
- 若路径不满足上述范围，会返回路径越界错误。

## 11. AI 分析失败会不会直接报错？
- 当外部 AI 服务超时或异常时，接口会自动重试并可降级返回规则摘要。
- 可在响应 `meta` 中查看：
  - `degraded`：是否触发降级
  - `retries`：重试次数
  - `errorClass`：错误分类（如 timeout/network/rate_limit）

## 12. 目录很多时监控不完整
- fsnotify 依赖系统文件句柄，目录数量过多可能触发 “too many open files”。
- 日志中会提示监控降级，可考虑提高系统 `ulimit` 或缩小监控范围。
- 可通过 `watch_exclude` 排除 `.git` 等大目录。

## 13. 告警控制台提示“告警未启用”
- 确认 `alert_enabled=true`，并在控制台配置了规则与日志路径。
- 规则未点击“保存规则”时不会生效，刷新会恢复为上次保存的规则。

## 14. 告警没有历史数据
- 检查 `alert_start_from_end` 是否为 `true`，该配置会忽略历史日志，仅处理新写入内容。
- 如需回溯历史日志，请改为 `false` 并留意可能产生大量历史告警。

## 15. 删除规则后刷新又回来了
- 删除只是前端内存变更，需点击“保存规则”才会写入 `config.runtime.yaml`。
- “刷新规则”会从 `config.runtime.yaml` 重新加载，覆盖未保存修改。

## 16. “最新窗口”是什么意思
- 告警概览统计最近 24 小时的告警决策，控制台“最新窗口”展示该统计窗口文案。

## 17. 系统资源控制台提示“未启用”或请求失败
- `/api/system` 需要先在控制台开启 `systemResourceEnabled`。
- 未开启时接口会返回 403，启用后再刷新页面。
- 新版控制台在点击“立即启用”失败时，会在页面内直接显示失败原因（如权限不足、后端不可达），可直接按提示排查。
- `mode=lite` 或 `mode=light` 会跳过进程列表采集，适合高频轮询。
- `limit` 用于限制返回进程数，`0` 表示不限制。
- 默认会隐藏进程环境变量，只有传 `includeEnv=true` 才返回。

## 18. 我应该看 `/api/health` 还是 `/metrics`？
- `/api/health`：看当前健康快照，适合控制台调试与快速排障。
- `/metrics`：看时序指标，适合 Prometheus 抓取、告警与趋势分析。

## 19. 如何快速确认指标是否齐全？
- 使用 `go-watch-file/scripts/ops/check-metrics.ps1` 直接巡检 `/metrics`。
- 可通过 `-OutputFile` 保存指标快照，便于前后对比。

## 20. 知识库问答怎么做“引用率门禁”？
- 执行 `go run ./cmd/kb-eval citation ... -target 1.0`。
- 当引用率低于目标值时，命令会返回非零退出码，可接入 CI 或发布门禁。

## 21. 现在接口访问策略是什么？
- 当前版本已移除 API Token 鉴权，管理接口默认匿名可访问。
- `/api/health` 始终允许匿名访问。
- 如需收紧访问范围，请配置 `API_CORS_ORIGINS` 并结合部署网络边界控制来源。

## 22. 控制台保存配置提示 `origin not allowed`（403）怎么办？
- 这是后端 CORS 拦截，表示当前前端地址不在允许来源列表。
- 先确认并设置环境变量：
  - `API_CORS_ORIGINS=http://localhost:5173,http://127.0.0.1:5173`
  - 如果前端不是 5173 端口，替换成实际地址。
- 改完后必须重启后端进程。
- 若 `API_CORS_ORIGINS` 为空，新版后端默认放行所有来源。
- 若需要限制来源，请显式配置 `API_CORS_ORIGINS` 白名单并重启后端。

## 23. 控制面控制台是做什么的？
- 控制面用于多 Agent 场景下的任务调度与追踪：看任务是否分配、执行、成功/失败/超时，并保留审计日志。
- 常用流程：筛选任务状态 -> 选择任务看事件流 -> 按 operator/action/time 筛审计日志。
- 它不是文件浏览器，也不替代日志 tail 页面。

## 24. 运维知识库应该怎么沉淀事故？
- 建议按“真实事件 -> 结构化元信息 -> Markdown 处置内容 -> 审核发布”的顺序沉淀。
- 控制台支持来源类型/来源编号（如 incident/alert/change）与事故模板，可直接生成“现象、适用条件、根因、处置步骤、复发条件、自动化建议”结构。
- 建议最少补齐：服务、环境、适用条件、来源编号，方便后续检索与 AI 推荐。

## 25. 控制台提示“仪表盘加载失败 500”怎么办？
- 先直接访问：
  - `GET /api/health`
  - `GET /api/dashboard`
  - `GET /api/dashboard?mode=light`
- 当前后端在运行态未就绪时会返回仪表盘降级数据（`200`）；若仍出现 `500`，优先检查：
  - 后端容器/进程日志；
  - `config.runtime.yaml` 的读写权限；
  - 前端 `VITE_API_BASE` 或反向代理地址是否指向正确后端。
