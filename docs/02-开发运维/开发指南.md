# 开发指南

> 文档状态：兼容保留  
> 校准日期：2026-02-24
> 口径说明：如与主线目录冲突，以 docs/00-文档治理/文档现行状态清单.md 与主线目录文档为准。

## 文档与注释规范
- 项目文档统一使用中文表达，新增文档需避免纯英文标题与说明
- 代码中的关键路径、并发控制、状态机、容错与降级逻辑必须补充中文注释
- 注释优先解释设计原因、边界条件与回滚思路，避免只复述代码字面行为
- 仓库协作规范统一参考根目录 `AGENTS.md`

## 环境准备
- Go 1.24+（`go.mod` 含 `toolchain go1.24.3`）。
- Node.js 18+（前端开发）。
- macOS + nvm 场景：新开终端若 `node`/`npm` 不可用，先执行 `source /etc/profile`，再用 `node -v && npm -v` 确认环境已生效。
- 阿里云 OSS（本地可用 MinIO/OSS/COS）。
- 钉钉机器人/SMTP 邮件（可选）。

## 本地启动（后端）
```bash
cd go-watch-file
cp .env.example .env
# config.yaml 放非密钥配置 密钥放在 .env
# watch_dir/告警配置建议在控制台配置并持久化

go build -o bin/file-watch cmd/main.go
./bin/file-watch -config config.yaml
```

### 配置要点
- `watch_dir` 为空时由控制台配置；如已设置则必须存在且为目录。
- `watch_dir` 支持多目录（逗号或分号分隔）。
- `file_ext` 支持多后缀（逗号或空格分隔），可留空表示不过滤。
- 临时文件后缀会被忽略（如 `.tmp/.part/.crdownload`）。
- `silence` 默认 `10s`，支持 `10s` / `10秒` / `10`。
- `upload_queue_persist_enabled`/`upload_queue_persist_file` 控制上传队列落盘（默认关闭，静态配置，需重启生效）。
  - 若持久化文件损坏，系统会备份损坏文件（`.corrupt-*.bak`）并降级为空队列继续运行。
- `upload_retry_enabled`/`upload_retry_delays` 可控制上传重试开关与间隔（默认 `1s,2s,5s`）。
- `upload_retry_max_attempts` 控制上传最大尝试次数（含首次，默认 `4`，静态配置，需重启生效）。
- `upload_etag_verify_enabled` 控制上传完成后 ETag 校验开关（默认 `false`，仅普通上传链路会比对本地 MD5 与 ETag，静态配置，需重启生效）。
- `upload_resumable_enabled`/`upload_resumable_part_size`/`upload_resumable_routines`/`upload_resumable_threshold`/`upload_resumable_checkpoint_dir` 控制断点续传链路（默认关闭，静态配置，需重启生效）。
  - 达到阈值后使用 OSS multipart + checkpoint 上传；multipart 链路不做本地 MD5 与 ETag 严格比对。
- `upload_queue_saturation_threshold` 控制队列饱和阈值（0~1，默认 `0.9`，静态配置，需重启生效）。
- `upload_queue_circuit_breaker_enabled` 控制饱和熔断限流开关（默认 `true`，静态配置，需重启生效）。
- `OSS_ENDPOINT` 可带协议或不带协议（如 `https://oss-cn-hangzhou.aliyuncs.com` 或 `oss-cn-hangzhou.aliyuncs.com`）。
- `OSS_FORCE_PATH_STYLE=true` 适配 MinIO 等场景。
- `system_resource_enabled` 默认 `false`，需在控制台开启后才能访问 `/api/system`。
- 管理接口默认不启用 API Token 鉴权。
- `/api/health` 始终允许匿名访问。
- `API_CORS_ORIGINS` 控制允许跨域来源，多个来源用逗号分隔。
  - 本地开发建议包含 `http://localhost:5173`（Vite）与 `http://localhost:8081`（前端容器）。

### 环境变量覆盖范围
- 仅会覆盖 OSS / 通知 / CORS / AI / 上传静态策略相关字段（`OSS_*`、`DINGTALK_*`、`EMAIL_*`、`ROBOT_KEY`、`API_*`、`AI_*`、`UPLOAD_QUEUE_PERSIST_*`、`UPLOAD_QUEUE_SATURATION_THRESHOLD`、`UPLOAD_QUEUE_CIRCUIT_BREAKER_ENABLED`、`UPLOAD_RETRY_MAX_ATTEMPTS`、`UPLOAD_ETAG_VERIFY_ENABLED`、`UPLOAD_RESUMABLE_*`）。
- `watch_dir` / `file_ext` / `watch_exclude` / `log_level` / `alert_*` 不会被环境变量覆盖。

### 告警模式配置要点
- 告警规则与日志路径可在控制台配置，并在可写时持久化到 `config.runtime.yaml`。
- `alert_rules` 只在 `config.runtime.yaml` 维护，规则更新需点击“保存规则”。
- `alert_start_from_end=true` 表示只处理新写入日志，避免历史告警。
- `alert_suppress_enabled=false` 可关闭抑制，所有命中都会发送通知。
- `GET /api/alerts` 的 `data.decisions[].explain` 提供结构化解释字段（决策来源、通知资格、抑制开关/窗口、抑制来源、升级阈值与计数）。
- 推荐使用双层模板维护规则：`go-watch-file/deploy/alert/gwf-alert-rules-layered-template.json`（默认规则 + 场景规则）。
- 可通过 `go-watch-file/scripts/ops/alert-rules-compose.ps1` 组合并发布到 `/api/alert-rules`。

### 本地 MinIO 示例（示意）
- `OSS_ENDPOINT=127.0.0.1:9000`
- `OSS_FORCE_PATH_STYLE=true`
- `OSS_DISABLE_SSL=true`

## 启动前端
```bash
source /etc/profile   # macOS + nvm 场景建议先执行
node -v
npm -v
cd console-frontend
npm install
npm run dev
```

前端默认通过 Vite 代理 `/api` 到 `http://localhost:8080`；若后端地址不同可设置 `VITE_API_BASE`。

前端门禁命令：
```bash
source /etc/profile   # macOS + nvm 场景建议先执行
cd console-frontend
npm run build
```

## Docker Compose 启动（可选）
```bash
cp .env.example .env
mkdir -p data/watch data/logs
# 如需固定监控目录 可将 go-watch-file/config.yaml 的 watch_dir 改为 /data/gwf/watch
docker compose up --build -d
```

访问地址：
- 后端 API：`http://localhost:8082`
- 前端控制台：`http://localhost:8081`

停止：
```bash
docker compose down
```

## 运行时配置更新
控制台保存配置会调用 `/api/config`，仅更新：
- `watchDir` / `fileExt` / `silence`
- `uploadWorkers` / `uploadQueueSize`
- `uploadRetryEnabled` / `uploadRetryDelays`
- `systemResourceEnabled`
- `upload_queue_persist_enabled` / `upload_queue_persist_file` / `upload_queue_saturation_threshold` / `upload_queue_circuit_breaker_enabled` / `upload_retry_max_attempts` / `upload_etag_verify_enabled` / `upload_resumable_*` 不在 `/api/config` 更新范围内，需改 `config.yaml` 或 `.env` 后重启。

OSS 连接参数可在 `config.yaml` 或 `.env` 中设置，密钥配置在 `.env`，变更后需重启后端。

告警配置通过 `/api/alert-config` 更新，实时生效，且在可写时持久化到 `config.runtime.yaml`。
告警规则通过 `/api/alert-rules` 保存并写入 `config.runtime.yaml`。

## 文件内容读取与检索
- `POST /api/file-log` 读取文件尾部（最多 512KB / 500 行）。
- 传入 `query` 可进行全文检索（最多 2000 行），支持 `limit` 与 `caseSensitive`。

## AI 日志分析
- `POST /api/ai/log-summary` 触发 AI 总结（需启用 `ai_enabled` 并配置 `AI_*`）。
- `path` 可来自 `watch_dir` 范围内文件，也可直接使用 `alert_log_paths` 中配置的后端日志文件。
- AI 超时或响应异常时会自动压缩输入并重试；若仍失败，会降级返回规则摘要（`meta.degraded=true`、`meta.errorClass`）。

## Prometheus 指标
- `GET /metrics` 暴露 Prometheus 文本格式指标（无需走 `/api/*`）。
- 关键指标：
  - 上传链路：`gwf_file_events_total`、`gwf_upload_queue_length`、`gwf_upload_duration_seconds`、`gwf_upload_failure_reason_total`。
  - 队列背压：`gwf_upload_queue_full_total`、`gwf_upload_queue_shed_total`、`gwf_upload_retry_total`。
  - AI：`gwf_ai_log_summary_total`、`gwf_ai_log_summary_retry_total`、`gwf_ai_log_summary_duration_seconds`。
  - 知识库：`gwf_kb_search_total`、`gwf_kb_search_hit_ratio`、`gwf_kb_ask_citation_ratio`、`gwf_kb_review_latency_ms`。
- `GET /api/kb/gates` 返回当前阶段知识库门禁阈值（检索命中率 `>=0.70`、问答引用率 `>=0.95`、评审时延 P95 `<=800ms`），控制台与复盘脚本应按该口径执行。
- 告警规则模板：`go-watch-file/deploy/prometheus/gwf-alert-rules.yaml`（队列/失败率/AI 降级率）。

## 仪表盘轻量刷新
- `GET /api/dashboard?mode=light` 或 `mode=lite` 返回不含目录树与文件列表的轻量数据，适合高频轮询。
- 全量 `GET /api/dashboard` 默认使用约 2 秒短缓存；调试时可加 `refresh=true` 强制刷新。
- 当运行态未就绪时，后端会返回降级结构（`200`），避免控制台直接出现 `500`。

## 运行测试
```bash
cd go-watch-file
go test ./...
```

## 运维知识库评估
命中率评估（20 条样本）：
```bash
cd go-watch-file
go run ./cmd/kb-eval hitrate -base http://localhost:8082 -samples ../docs/04-知识库/知识库命中率样本.json
```

问答引用率评估（目标默认 95%）：
```bash
cd go-watch-file
go run ./cmd/kb-eval citation -base http://localhost:8082 -samples ../docs/04-知识库/知识库命中率样本.json -limit 3 -target 0.95
```

MTTD 对比评估：
```bash
cd go-watch-file
go run ./cmd/kb-eval mttd -input ../docs/04-知识库/知识库MTTD基线.csv
```

知识库复盘汇总（hitrate/citation/mttd 一次执行）：
```powershell
cd go-watch-file
powershell -ExecutionPolicy Bypass -File scripts/ops/kb-recap.ps1 -BaseUrl http://localhost:8082 -SamplesFile ../docs/04-知识库/知识库命中率样本.json -MttdFile ../docs/04-知识库/知识库MTTD基线.csv -CitationTarget 0.95 -HitrateTarget 0.7 -MttdDropTarget 0.2 -OutputFile ../reports/kb-recap-result.json -ReportFile ../docs/05-指标与评估/知识库命中率与引用率阶段复盘改进清单-$(Get-Date -Format yyyy-MM-dd).md
```
离线复盘模式（不访问服务，直接从已有结果生成改进清单）：
```powershell
cd go-watch-file
powershell -ExecutionPolicy Bypass -File scripts/ops/kb-recap.ps1 -FromResultFile ../reports/kb-recap-result.json -OutputFile ../reports/kb-recap-result.json -ReportFile ../docs/05-指标与评估/知识库命中率与引用率阶段复盘改进清单-$(Get-Date -Format yyyy-MM-dd).md
```

## 可靠性与 AI 回放脚本

macOS/Linux 推荐直接使用 bash 脚本（无需 PowerShell）：
```bash
cd go-watch-file
DATE_TAG="$(date +%F)"

# Day1: 上传链路压测与轻量复盘（队列/失败率/打满增量）
# 注意：压测会触发上传成功通知，执行前建议切换测试 webhook 或临时关闭通知通道。
bash scripts/ops/upload-recap-lite.sh \
  --base-url http://localhost:8080 \
  --watch-dir /tmp/gwf-upload-stress \
  --saturation-count 1200 \
  --saturation-interval-ms 5 \
  --max-failure-ratio 0.05 \
  --max-queue-full-delta 0 \
  --output-file ../reports/upload-recap-"$DATE_TAG".json \
  --report-file ../reports/upload-recap-"$DATE_TAG".md

# Day2: AI 周度复盘（回放 + 基线）
bash scripts/ops/ai-weekly-recap.sh \
  --base-url http://localhost:8080 \
  --paths-file ../docs/03-告警与AI/AI回放路径清单.txt \
  --date "$DATE_TAG" \
  --out-dir ../reports

# Day4: 控制台闭环与降级验收
bash scripts/ops/console-closure-check.sh \
  --base-url http://localhost:8080 \
  --log-path /Users/yourname/Code/GO/GWF/go-watch-file/logs/file-monitor.log \
  --output-file ../reports/console-closure-check-"$DATE_TAG".json

# Day5: 阶段轻量复盘汇总
bash scripts/ops/stage-recap-lite.sh \
  --ai-baseline ../reports/ai-baseline-"$DATE_TAG".json \
  --kb-drill ../reports/kb-failure-rollback-drill-"$DATE_TAG".json \
  --console-check ../reports/console-closure-check-"$DATE_TAG".json \
  --output-file ../reports/stage-recap-"$DATE_TAG"-lite.json
```

以下 PowerShell 命令保留用于兼容历史流程：

基础验证（go test + 单机上传 + 通知观测）：
```powershell
cd go-watch-file
powershell -ExecutionPolicy Bypass -File scripts/ops/basic-e2e.ps1 -BaseUrl http://localhost:8082 -WaitTimeoutSec 90 -RequireNotification -OutputFile ../reports/basic-e2e-result.json -ReportFile ../docs/05-指标与评估/基础验证报告-$(Get-Date -Format yyyy-MM-dd).md
```
- 可选 `-WatchDir` 指定验证目录；不传时默认读取仪表盘 `heroCopy.watchDirs[0]`。
- 若当前环境未配置钉钉/邮件，可去掉 `-RequireNotification`，仅验证上传链路与指标增量。

指标巡检：
```powershell
cd go-watch-file
powershell -ExecutionPolicy Bypass -File scripts/ops/check-metrics.ps1 -BaseUrl http://localhost:8082 -OutputFile ../reports/metrics.prom
```
阈值巡检（可选门禁）：
```powershell
cd go-watch-file
powershell -ExecutionPolicy Bypass -File scripts/ops/check-metrics.ps1 -BaseUrl http://localhost:8082 -CheckThresholds -OutputFile ../reports/metrics.prom
```
- 若希望 Warning 也阻断流程，追加 `-FailOnWarning`。
- 退出码约定：`4=Critical 阈值触发`，`5=Warning 阈值触发且启用 -FailOnWarning`。

告警规则模板收敛（默认规则 + 场景规则）：
```powershell
cd go-watch-file
powershell -ExecutionPolicy Bypass -File scripts/ops/alert-rules-compose.ps1 -TemplateFile ./deploy/alert/gwf-alert-rules-layered-template.json -Scenarios "database,upload,ai,control" -OutputFile ../reports/alert-rules-composed.json
```
若要直接发布到后端，增加 `-Apply -BaseUrl http://localhost:8082`。

上传压测文件生成：
```powershell
cd go-watch-file
powershell -ExecutionPolicy Bypass -File scripts/ops/upload-stress.ps1 -WatchDir D:\tmp\gwf-stress -Count 1000 -IntervalMs 20
```

上传链路压测与故障注入复盘（自动输出报告）：
```powershell
cd go-watch-file
powershell -ExecutionPolicy Bypass -File scripts/ops/upload-recap.ps1 -BaseUrl http://localhost:8082 -WatchDir D:\tmp\gwf-stress -FaultMode manual -SaturationCount 1200 -FaultCount 400 -RecoveryCount 300 -OutputFile ../reports/upload-recap-result.json -ReportFile ../docs/05-指标与评估/上传链路压测与故障注入报告-$(Get-Date -Format yyyy-MM-dd).md
```
- `FaultMode=none`：仅执行队列压测。
- `FaultMode=manual`：脚本在故障窗口等待手工注入/恢复。
- `FaultMode=command`：通过 `-FaultStartCommand/-FaultRecoverCommand` 自动注入与恢复。

AI 回放与降级统计：
```powershell
cd go-watch-file
powershell -ExecutionPolicy Bypass -File scripts/ops/ai-replay.ps1 -BaseUrl http://localhost:8082 -PathsFile ../docs/03-告警与AI/AI回放路径清单.txt -DegradedRatioTarget 0.20 -StructurePassRatioTarget 1.00 -ErrorClassCoverageTarget 1.00 -FailOnGate -OutputFile ../reports/ai-replay-result.json
```
可先复制 `docs/03-告警与AI/AI回放路径样本.txt`，再按环境修改 `docs/03-告警与AI/AI回放路径清单.txt`；样例场景矩阵参考 `docs/03-告警与AI/AI回放样例集清单.md`。

AI 基线验证（固定样例 + 结构稳定性）：
```powershell
cd go-watch-file
powershell -ExecutionPolicy Bypass -File scripts/ops/ai-baseline.ps1 -BaseUrl http://localhost:8082 -PathsFile ../docs/03-告警与AI/AI回放路径清单.txt -SummaryPassRatioTarget 1.00 -SeverityPassRatioTarget 1.00 -SuggestionsPassRatioTarget 1.00 -OutputFile ../reports/ai-baseline-result.json -ReportFile ../docs/05-指标与评估/AI基线验证报告-$(Get-Date -Format yyyy-MM-dd).md
```
离线复核模式（不访问服务）：
```powershell
cd go-watch-file
powershell -ExecutionPolicy Bypass -File scripts/ops/ai-baseline.ps1 -FromResultFile ../reports/ai-replay-result.json -OutputFile ../reports/ai-baseline-result.json
```
- 若 `ai-replay` 结果缺少 `structure.*` 或 `results[].structureIssues`，基线脚本会判定为失败，提示补齐新口径回放结果。
- 周度复盘建议按手册执行并使用统一模板归档：
  - `docs/03-告警与AI/AI周度基线复盘手册.md`
  - `docs/05-指标与评估/AI周度基线复盘模板-v1.md`

阶段预备（自动导入并发布知识库文档 + 生成 AI 回放样本并登记告警日志路径）：
```powershell
cd go-watch-file
powershell -ExecutionPolicy Bypass -File scripts/ops/stage-prime.ps1 -BaseUrl http://localhost:8082 -DocsPath ../docs -Operator stage-recap -AIPathsFile ../reports/ai-replay-paths-prime.txt -OutputFile ../reports/stage-prime-result.json
```

控制面任务回放（register -> pull -> ack -> complete）：
```powershell
cd go-watch-file
powershell -ExecutionPolicy Bypass -File scripts/ops/control-replay.ps1 -BaseUrl http://localhost:8082 -AgentCount 3 -TaskCount 30 -OutputFile ../reports/control-replay-result.json -MetricsFile ../reports/metrics-control-replay.prom
```

控制面 Agent 在线巡检（在线判定 + `/metrics` 对账）：
```powershell
cd go-watch-file
powershell -ExecutionPolicy Bypass -File scripts/ops/control-agent-check.ps1 -BaseUrl http://localhost:8082 -OfflineAfterSec 45 -FailOnOffline -MaxOfflineAgents 0 -OutputFile ../reports/control-agent-check-result.json -ReportFile ../docs/05-指标与评估/控制面Agent在线巡检报告-$(Get-Date -Format yyyy-MM-dd).md
```
- 手册入口：`docs/02-开发运维/控制面Agent在线状态判定与巡检手册.md`。

阶段一键复盘（metrics + ai + control + kb，默认全量）：
```powershell
cd go-watch-file
powershell -ExecutionPolicy Bypass -File scripts/ops/stage-recap.ps1 -BaseUrl http://localhost:8082 -AIPathsFile ../docs/03-告警与AI/AI回放路径清单.txt -AILimit 200 -AIDegradedRatioTarget 0.20 -AIStructurePassRatioTarget 1.00 -AIErrorClassCoverageTarget 1.00 -KBHitrateTarget 0.7 -CitationTarget 0.95 -KBMttdDropTarget 0.2 -OutputFile ../reports/stage-recap-result.json
```
按需跳过阶段可增加 `-SkipAIReplay` / `-SkipControlReplay` / `-SkipKBRecap`。
本地演练环境建议增加 `-AutoPrime`，自动补齐知识库与 AI 回放前置条件：
```powershell
cd go-watch-file
powershell -ExecutionPolicy Bypass -File scripts/ops/stage-recap.ps1 -BaseUrl http://localhost:8082 -AutoPrime -AIPathsFile ../reports/ai-replay-paths-prime.txt -OutputFile ../reports/stage-recap-result.json
```

阶段报告生成（从复盘 JSON 输出 Markdown）：
```powershell
cd go-watch-file
powershell -ExecutionPolicy Bypass -File scripts/ops/stage-report.ps1 -RecapFile ../reports/stage-recap-result.json -OutputFile ../docs/05-指标与评估/阶段回归报告-$(Get-Date -Format yyyy-MM-dd).md -Operator "your-name" -Environment "dev-like (local)"
```
控制面审计查询（按 operator/action/time 过滤）：
```powershell
Invoke-RestMethod -Uri "http://localhost:8082/api/control/audit?resourceType=task&resourceId=tsk-000001&operator=console&action=task_create&from=2026-02-18T00:00:00Z&to=2026-02-18T23:59:59Z&limit=200"
```
- `from/to` 支持 `RFC3339`（如 `2026-02-18T00:00:00Z`）与 `YYYY-MM-DDTHH:mm`（如 `2026-02-18T09:30`）。

脚本细节与验收口径参考：
- `docs/05-指标与评估/监控指标字典-v1.md`
- `docs/05-指标与评估/指标告警阈值草案-v0.1.md`
- `docs/03-告警与AI/上传可靠性演练手册.md`
- `docs/03-告警与AI/AI回放验收手册.md`
- `docs/05-指标与评估/阶段回归报告模板-v1.md`

## 常见开发验证
- 新建文件后等待静默窗口结束，再观察上传与通知。
- 通过 `/api/dashboard` 验证目录树、上传记录与队列趋势。
- 通过 `/api/health` 观察队列饱和计数、熔断限流计数、重试计数、失败原因分布与 `persistQueue` 健康指标。
- 通过 `/metrics` 验证 Prometheus 指标暴露与标签维度。
- 通过 `/api/alerts` 验证告警概览、决策列表与 `decisions[].explain` 的抑制/升级解释字段。
- `LOG_LEVEL=debug` 便于追踪 watcher 与 queue 行为。
