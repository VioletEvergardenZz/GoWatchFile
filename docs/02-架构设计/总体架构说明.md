# 总体架构说明

## 1. 架构目标

围绕“运维事件处理闭环”构建统一平台能力，满足以下要求：

- 可观测：关键链路可监控、可量化。
- 可追溯：任务、告警、知识决策有审计与历史记录。
- 可执行：支持从发现问题到执行处置的端到端操作路径。

## 2. 当前逻辑架构

```text
┌────────────────────────────────────────────────────┐
│                  Console Frontend                  │
│   主控制台 / 告警控制台 / 系统资源 / 知识库 / 控制面  │
└───────────────────────┬────────────────────────────┘
                        │ HTTP API
┌───────────────────────▼────────────────────────────┐
│               go-watch-file Backend               │
│                                                    │
│  [控制面] Agent/Task/Dispatch/Audit               │
│  [告警] Rules/Polling/Suppress/Escalation         │
│  [系统] Host Metrics/Process View/Terminate       │
│  [知识库] Article/Search/Ask/Recommend/Import     │
│  [采集适配] Watcher/Upload/Retry/Queue            │
│  [通用能力] Auth/CORS/Runtime Config/Metrics      │
└──────────────┬───────────────────────┬─────────────┘
               │                       │
      ┌────────▼────────┐     ┌────────▼────────┐
      │  本地状态与文件   │     │    外部存储      │
      │  runtime/config  │     │    OSS 对象存储  │
      │  queue persistence│    │                 │
      └────────┬────────┘     └─────────────────┘
               │
      ┌────────▼────────┐
      │  SQLite 本地库   │
      │  control.db      │
      │  knowledge.db    │
      └─────────────────┘
```

## 3. 关键运行闭环

### 3.1 控制闭环（核心）

1. Agent 注册并上报心跳。
2. 控制面创建任务并进入待分发队列。
3. Agent 拉取任务，执行后回传进度与结果。
4. 系统记录任务事件与审计日志，暴露指标。

### 3.2 告警决策闭环（核心）

1. 告警模块轮询日志输入。
2. 规则匹配并进行抑制/升级判断。
3. 输出告警决策记录并可触发通知。
4. 控制台展示概览、明细与规则状态。

### 3.3 知识复用闭环（核心）

1. 知识条目创建、更新、评审、回滚。
2. 检索与问答返回引用答案。
3. 告警场景可请求知识推荐。
4. 指标评估命中率、引用率、评审时延。

### 3.4 资源可观测闭环（核心）

1. 采集 CPU/内存/磁盘/进程等主机指标。
2. 提供系统视图与轻量处置接口（进程终止）。
3. 与告警与任务场景联动提供排障上下文。

### 3.5 文件采集闭环（辅助）

1. 监听目录并识别写入完成文件。
2. 进行后缀过滤、队列入队与并发上传。
3. 记录上传结果与失败原因。
4. 将状态反馈到仪表盘和指标系统。

## 4. 跨模块通用能力

- API 访问策略与 CORS 策略。
- 运行时配置更新与 `config.runtime.yaml` 持久化。
- `/metrics` 指标暴露（上传、控制面、知识库等）。
- 健康检查与降级返回策略。

## 5. 当前技术约束

- 控制面与知识库存储为单实例本地 SQLite，暂不具备多节点一致性。
- 核心服务以单后端进程聚合，尚未拆分为独立微服务。
- 权限模型当前以 Token 为主，未引入 RBAC/租户隔离。
- 文件采集适配器目前仍是主要输入实现，其他输入源待扩展。

## 6. 架构演进原则

- 主线优先：优先保障控制面、告警、知识库、系统观测四条核心闭环。
- 兼容演进：辅助能力演进不得破坏核心闭环稳定性。
- 明确边界：每个新能力必须先定义模块边界，再进入开发。
