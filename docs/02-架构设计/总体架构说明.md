# 总体架构说明

> 文档状态：现行（主线）  
> 校准日期：2026-02-24
> 口径说明：该文档为主线口径，发生边界变更时需优先更新。

## 1. 架构目标

围绕“运维事件处理闭环”构建统一平台能力，满足以下要求：

- 可观测：关键链路可监控、可量化。
- 可追溯：任务、告警、知识决策有审计与历史记录。
- 可执行：支持从发现问题到执行处置的端到端操作路径。

## 2. 当前逻辑架构

```text
┌────────────────────────────────────────────────────┐
│                  Console Frontend                  │
│   主控制台 / 告警控制台 / 系统资源 / 知识库 / 控制面  │
└───────────────────────┬────────────────────────────┘
                        │ HTTP API
┌───────────────────────▼────────────────────────────┐
│               go-watch-file Backend               │
│                                                    │
│  [控制面] Agent/Task/Dispatch/Audit               │
│  [文件入云] Watcher/Upload/Retry/Queue            │
│  [告警] Rules/Polling/Suppress/Escalation         │
│  [AI分析] LogSummary/Fallback/Trace               │
│  [系统] Host Metrics/Process View/Terminate       │
│  [知识库] Article/Search/Ask/Recommend/Import     │
│  [通用能力] Auth/CORS/Runtime Config/Metrics      │
└──────────────┬───────────────────────┬─────────────┘
               │                       │
      ┌────────▼────────┐     ┌────────▼────────┐
      │  本地状态与文件   │     │    外部存储      │
      │  runtime/config  │     │    OSS 对象存储  │
      │  queue persistence│    │                 │
      └────────┬────────┘     └─────────────────┘
               │
      ┌────────▼────────┐
      │  SQLite 本地库   │
      │  control.db      │
      │  knowledge.db    │
      └─────────────────┘
```

## 3. 关键运行闭环

### 3.1 文件入云闭环（核心）

1. 监听目录并识别写入完成文件（静默窗口判定）。
2. 按后缀与排除规则过滤后入队。
3. Worker 并发上传，失败按策略重试并受队列回压保护。
4. 上传结果回写运行态与指标，供控制台观测与回放。

### 3.2 告警决策闭环（核心）

1. 告警模块轮询日志输入。
2. 规则匹配并进行抑制/升级判断。
3. 输出告警决策记录并可触发通知。
4. 控制台展示概览、明细与规则状态。
5. 告警详情触发知识推荐时，推荐结果以 `alertId` 关联回告警决策（`knowledgeTrace`），便于后续追溯。

### 3.3 AI 分析闭环（核心）

1. 文件入云与告警链路提供日志片段和上下文。
2. AI 分析接口输出结构化摘要与建议。
3. 超时/网络异常时触发降级策略，返回可读失败分类。
4. 分析结果与元信息写入响应 `meta`，支撑后续回放与追溯。

### 3.4 知识复用闭环（核心）

1. 知识条目创建、更新、评审、回滚。
2. 检索与问答返回引用答案。
3. 告警场景可请求知识推荐。
4. 指标评估命中率、引用率、评审时延。

### 3.5 控制台统一闭环（核心）

1. 在同一套控制台统一承载发现、诊断、回放与追溯。
2. 告警详情可联动 AI 分析结果与知识推荐结果。
3. 回放记录可关联上传状态、告警决策与知识引用链路。
4. 闭环路径保持匿名可访问前提下的降级可用（关键接口异常时返回可读兜底数据）。

### 3.6 支撑闭环（控制面 + 资源观测）

1. 控制面管理 Agent、任务与审计，为主线能力提供可执行载体。
2. 资源采集提供 CPU/内存/磁盘/进程上下文，支撑故障定位与轻量处置。
3. 支撑能力必须服务主线收口，不得反向扩大本阶段范围。

## 4. 跨模块通用能力

- API 访问策略与 CORS 策略。
- 运行时配置更新与 `config.runtime.yaml` 持久化。
- `/metrics` 指标暴露（上传、控制面、知识库等）。
- 健康检查与降级返回策略。

## 5. 当前技术约束

- 控制面与知识库存储为单实例本地 SQLite，暂不具备多节点一致性。
- 核心服务以单后端进程聚合，尚未拆分为独立微服务。
- 权限模型当前为“管理接口默认匿名访问 + CORS/审计日志兜底”，尚未引入 RBAC/租户隔离。
- 当前阶段优先单团队/单租户闭环，复杂多用户、多租户、细粒度 RBAC/计费能力暂缓。
- 文件入云当前以本地文件监控为主，手动/API 输入为补充路径，其他输入源待扩展。

## 6. 架构演进原则

- 主线优先：优先保障文件入云、告警决策、AI 分析、知识复用与统一控制台五条主线闭环。
- 支撑护航：控制面、系统资源、通知等支撑能力以保障主线稳定为目标。
- 兼容演进：兼容目录中的历史能力描述不得覆盖主线口径。
- 明确边界：每个新能力必须先定义模块边界，再进入开发。
