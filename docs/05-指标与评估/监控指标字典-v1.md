# 监控指标字典 v1

- 更新时间：2026-02-18
- 指标实现：`go-watch-file/internal/metrics/prometheus.go`
- 采集入口：`GET /metrics`

## 1. 使用约定

- 所有计数型指标为累计值，建议配合 `rate`/`increase` 使用
- 比率类指标由服务端直接输出 `gauge`，范围 `0~1`
- 直方图指标遵循 Prometheus 命名规范（`_bucket/_sum/_count`）

## 2. 上传链路指标

| 指标名 | 类型 | 标签 | 含义 | 建议用途 |
| --- | --- | --- | --- | --- |
| `gwf_file_events_total` | counter | 无 | watcher 识别并尝试入队的文件事件总数 | 入口流量基线 |
| `gwf_upload_queue_length` | gauge | 无 | 当前上传队列长度 | 背压观察 |
| `gwf_upload_inflight` | gauge | 无 | 当前执行中的上传任务数 | 并发占用观察 |
| `gwf_upload_workers` | gauge | 无 | 当前 worker 数量 | 配置核对 |
| `gwf_upload_queue_full_total` | counter | 无 | 队列已满导致入队失败总数 | 容量不足告警 |
| `gwf_upload_queue_shed_total` | counter | 无 | 达到饱和阈值后主动限流总数 | 熔断触发告警 |
| `gwf_upload_retry_total` | counter | 无 | 上传重试总次数 | 外部依赖波动观察 |
| `gwf_upload_success_total` | counter | 无 | 上传成功总数 | 成功率计算 |
| `gwf_upload_failure_total` | counter | 无 | 上传失败总数 | 失败率计算 |
| `gwf_upload_failure_reason_total` | counter | `reason` | 按失败原因聚合的上传失败次数 | Top 错误归因 |
| `gwf_upload_duration_seconds` | histogram | 无 | 上传耗时分布（秒） | P95/P99 延迟监控 |

## 3. AI 日志分析指标

| 指标名 | 类型 | 标签 | 含义 | 建议用途 |
| --- | --- | --- | --- | --- |
| `gwf_ai_log_summary_total` | counter | `outcome` | AI 日志分析请求总数，`outcome` 当前取值 `success/degraded` | 成功与降级占比 |
| `gwf_ai_log_summary_retry_total` | counter | 无 | AI 分析重试总次数 | 超时/网络波动观察 |
| `gwf_ai_log_summary_duration_seconds` | histogram | 无 | AI 分析耗时分布（秒） | AI 接口性能监控 |

## 4. 知识库指标

| 指标名 | 类型 | 标签 | 含义 | 建议用途 |
| --- | --- | --- | --- | --- |
| `gwf_kb_search_total` | counter | 无 | 知识检索请求总数 | 检索请求规模 |
| `gwf_kb_search_hit_total` | counter | 无 | 至少命中 1 条结果的检索次数 | 命中率分母分子 |
| `gwf_kb_search_hit_ratio` | gauge | 无 | 检索命中率（`hit_total/search_total`） | 运营质量目标 |
| `gwf_kb_ask_total` | counter | 无 | 知识问答请求总数 | 问答请求规模 |
| `gwf_kb_ask_citation_total` | counter | 无 | 含引用的问答次数 | 引用约束覆盖 |
| `gwf_kb_ask_citation_ratio` | gauge | 无 | 问答引用率（`citation_total/ask_total`） | 可信度门禁 |
| `gwf_kb_review_latency_ms` | histogram | 无 | 知识评审动作耗时分布（毫秒） | 审核流程效率 |

## 5. 控制面指标

| 指标名 | 类型 | 标签 | 含义 | 建议用途 |
| --- | --- | --- | --- | --- |
| `gwf_control_agents_total` | gauge | 无 | 控制面 Agent 总数（注册记录数） | 规模基线 |
| `gwf_control_agents_online` | gauge | 无 | 在线 Agent 数（按最后心跳时间判定） | 在线率 |
| `gwf_control_agent_heartbeat_lag_seconds` | gauge | 无 | 最大心跳延迟（秒，当前实现为 max） | 离线风险预警 |
| `gwf_control_task_backlog` | gauge | 无 | 当前 backlog（`pending` 任务数） | 滞留观察 |
| `gwf_control_tasks_total` | gauge | `status,type` | 任务数量快照（按状态与类型聚合，注意该指标为 gauge） | 状态分布 |
| `gwf_control_task_timeout_total` | counter | 无 | 任务超时累计次数 | 超时率 |
| `gwf_control_task_duration_seconds` | histogram | 无 | 任务耗时分布（秒） | P95/P99 延迟监控 |

## 6. 推荐看板分组

- 上传稳定性：`queue_length`、`queue_full_total`、`queue_shed_total`、`upload_failure_total`
- AI 稳定性：`ai_log_summary_total{outcome="degraded"}`、`ai_log_summary_retry_total`、`ai_log_summary_duration_seconds`
- 知识库运营：`kb_search_hit_ratio`、`kb_ask_citation_ratio`、`kb_review_latency_ms`
- 控制面：`control_agents_online`、`control_task_backlog`、`control_task_timeout_total`、`control_task_duration_seconds`

## 7. 最小巡检命令

```powershell
cd go-watch-file
powershell -ExecutionPolicy Bypass -File scripts/ops/check-metrics.ps1 -BaseUrl http://localhost:8082 -OutputFile ../reports/metrics.prom
```
