# 指标告警阈值草案 v0.1

> 文档状态：兼容保留

- 更新时间：2026-02-19
- 适用范围：GWF 单实例部署（默认队列大小 `100`）
- 阶段策略：先观察 1 周，再固化阈值

## 1. 使用原则

- 阈值按“告警级别 + 持续时间”组合，不用瞬时尖峰直接报警
- 生产首周建议仅开 Warning，不自动通知业务群
- 队列容量若非 `100`，请按比例线性换算队列阈值

## 2. 上传链路告警

| 告警项 | PromQL（草案） | 建议级别 | 触发条件 | 处理动作 |
| --- | --- | --- | --- | --- |
| 队列持续高位 | `max_over_time(gwf_upload_queue_length[5m]) > 80` | Warning | 持续 5m | 提升 `upload_workers` 或排查下游慢 |
| 队列接近打满 | `max_over_time(gwf_upload_queue_length[5m]) > 95` | Critical | 持续 3m | 立即扩容或临时限流写入端 |
| 队列满事件 | `increase(gwf_upload_queue_full_total[5m]) >= 1` | Critical | 5m 内出现 | 立即检查队列容量与入队速率 |
| 饱和熔断触发 | `increase(gwf_upload_queue_shed_total[5m]) >= 10` | Warning | 5m 内触发 | 排查是否持续过载 |
| 上传失败率高 | `increase(gwf_upload_failure_total[10m]) / clamp_min(increase(gwf_upload_success_total[10m]) + increase(gwf_upload_failure_total[10m]), 1) > 0.05` | Warning | 持续 10m | 按 `gwf_upload_failure_reason_total` 定位原因 |
| 上传失败率严重 | 同上表达式 `> 0.15` | Critical | 持续 5m | 触发值班升级，必要时暂停高风险写入 |

## 3. AI 稳定性告警

| 告警项 | PromQL（草案） | 建议级别 | 触发条件 | 处理动作 |
| --- | --- | --- | --- | --- |
| AI 降级率高 | `sum(increase(gwf_ai_log_summary_total{outcome="degraded"}[15m])) / clamp_min(sum(increase(gwf_ai_log_summary_total[15m])), 1) > 0.20` | Warning | 持续 15m | 检查模型端限流/超时，评估降级可用性 |
| AI 降级率严重 | 同上表达式 `> 0.40` | Critical | 持续 10m | 切换备用模型或临时关闭 AI 入口 |
| AI 重试异常增高 | `increase(gwf_ai_log_summary_retry_total[15m]) > 30` | Warning | 15m 内触发 | 检查网络与 AI 超时参数 |
| AI 耗时过高 | `histogram_quantile(0.95, sum(rate(gwf_ai_log_summary_duration_seconds_bucket[15m])) by (le)) > 8` | Warning | 持续 15m | 调整 `AI_TIMEOUT`、压缩输入行数 |

## 4. 知识库运营告警

| 告警项 | PromQL（草案） | 建议级别 | 触发条件 | 处理动作 |
| --- | --- | --- | --- | --- |
| 检索命中率偏低 | `avg_over_time(gwf_kb_search_hit_ratio[30m]) < 0.70` | Warning | 持续 30m | 补充知识条目、优化标签 |
| 问答引用率不达标 | `avg_over_time(gwf_kb_ask_citation_ratio[30m]) < 0.95` | Critical | 持续 30m | 阻断自动回答放量，优先修复引用链路 |
| 评审延迟偏高 | `histogram_quantile(0.95, sum(rate(gwf_kb_review_latency_ms_bucket[30m])) by (le)) > 800` | Warning | 持续 30m | 排查审核队列与人工流程瓶颈 |

## 5. 控制面告警（MVP）

| 告警项 | PromQL（草案） | 建议级别 | 触发条件 | 处理动作 |
| --- | --- | --- | --- | --- |
| 无在线 Agent | `min_over_time(gwf_control_agents_online[5m]) < 1` | Critical | 持续 5m | 排查 agent 进程是否退出、网络是否阻断、控制面服务是否可达 |
| 心跳延迟偏高 | `max_over_time(gwf_control_agent_heartbeat_lag_seconds[5m]) > 60` | Warning | 持续 5m | 排查 agent 是否卡顿、CPU/GC 是否异常、网络是否抖动 |
| backlog 持续高位 | `max_over_time(gwf_control_task_backlog[5m]) > 50` | Warning | 持续 5m | 检查任务生产速率与 agent 消费能力，必要时扩容 agent |
| backlog 严重堆积 | `max_over_time(gwf_control_task_backlog[5m]) > 200` | Critical | 持续 5m | 触发值班升级，暂停高风险任务创建或临时降载 |
| 任务超时增长 | `increase(gwf_control_task_timeout_total[10m]) >= 1` | Warning | 10m 内出现 | 排查任务执行端是否卡死，必要时调整 runTimeout 或加 progress 上报 |
| 任务耗时过高 | `histogram_quantile(0.95, sum(rate(gwf_control_task_duration_seconds_bucket[15m])) by (le)) > 30` | Warning | 持续 15m | 排查任务类型分布与外部依赖延迟 |

## 6. 首周校准流程

1. 每天导出一次指标快照，记录峰值与业务时段
2. 复盘误报与漏报，调整阈值和持续时间
3. 第 7 天冻结 v1 阈值，更新到告警系统

## 7. 配套脚本

- 指标可用性巡检：`go-watch-file/scripts/ops/check-metrics.ps1`
- 上传压测数据生成：`go-watch-file/scripts/ops/upload-stress.ps1`
- AI 回放统计：`go-watch-file/scripts/ops/ai-replay.ps1`
- 控制面回放：`go-watch-file/scripts/ops/control-replay.ps1`
- Prometheus 告警规则模板：`go-watch-file/deploy/prometheus/gwf-alert-rules.yaml`

## 8. 落地建议（当前版本）

1. 先使用 `deploy/prometheus/gwf-alert-rules.yaml` 接入告警平台，开启观察模式。
2. 在巡检链路中增加阈值快照检查：
   `powershell -ExecutionPolicy Bypass -File go-watch-file/scripts/ops/check-metrics.ps1 -BaseUrl http://localhost:8082 -CheckThresholds`
3. 若需将 Warning 也纳入发布门禁，增加 `-FailOnWarning`。
