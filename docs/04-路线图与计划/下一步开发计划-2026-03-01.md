# 下一步开发计划（2026-03-01）

> 文档状态：现行（主线）  
> 更新时间：2026-03-01  
> 适用阶段：阶段 A 收口执行（2026-03-02 ~ 2026-03-13）  
> 口径说明：本计划只覆盖 A 类收口任务，不进入 P1/P2 新能力开发。

## 0. 当前状态与问题

截至 2026-03-01，`docs/04-路线图与计划/TODO.md` 中 P0 条目已全部关闭，首轮执行产物已落盘：

- `reports/ai-replay-2026-02-24.json`
- `reports/ai-baseline-2026-02-24.json`
- `reports/kb-failure-rollback-drill-2026-02-24.json`
- `reports/console-closure-check-2026-02-24.json`
- `reports/stage-recap-2026-02-24-lite.json`

当前缺口：

1. 首轮回放样本量偏小（AI 回放仅 3 条），异常覆盖不足。  
2. 收口结果以“单次通过”为主，尚未形成“连续两轮稳定回归”证据。  
3. 最小安全能力（路径防穿越、CORS、降级接口）缺少周度固定回归节奏。

## 1. 本轮目标与边界

### 1.1 本轮目标

1. 将 A 类能力从“可用”推进到“可回归”（连续两轮可复现）。  
2. 固化周度执行节奏，确保 `reports/` 产物可追溯、可对比。  
3. 输出阶段 A 收口周结，作为后续 P1 立项输入（仅做输入，不提前开发）。

### 1.2 范围边界

仅处理以下 A 类收口工作：

- 文件入云稳定性回归（压测、队列、失败分类）
- AI 分析与降级周度复盘（含样本扩容）
- 知识库失败与回滚演练复核
- 控制台闭环与 `/api/dashboard` 降级回归
- 最小安全回归（路径、防越权、CORS）
- 测试门禁与文档同步

本轮不做：

- 控制面分组调度/批量任务等 P1 新功能开发
- SLA/SLO 跨模块指标体系重构
- 非文件输入扩展、多租户、RBAC、计费体系

## 2. 执行工作包（按顺序）

### 工作包 1：文件入云稳定性双轮回归（D1~D2）

### 要解决的问题

需要把“上传链路可用”转成“高压下稳定、失败可解释、指标可追踪”。

### 执行动作

1. 执行上传压测与复盘：
   - `powershell -ExecutionPolicy Bypass -File scripts/ops/upload-stress.ps1 -WatchDir <watch_dir>`
   - `powershell -ExecutionPolicy Bypass -File scripts/ops/upload-recap.ps1 -WatchDir <watch_dir> -OutputFile ../reports/upload-recap-2026-03-02.json`
2. 执行指标巡检（含阈值检查）：
   - `powershell -ExecutionPolicy Bypass -File scripts/ops/check-metrics.ps1 -BaseUrl http://localhost:8082 -CheckThresholds`
3. 按同口径在 D2 再执行一轮，产出 `2026-03-03` 版本报告。

### 验收口径

- `gwf_upload_queue_full_total` 增量为 `0`。  
- 上传失败率在 10 分钟窗口内低于 `5%`（阈值草案口径）。  
- 失败原因可从 `gwf_upload_failure_reason_total` 解释，不出现“无分类失败”。

### 工作包 2：AI 周度复盘与降级样本扩容（D3~D5）

### 要解决的问题

现有 AI 基线通过，但样本覆盖不足，无法有效监控回退风险。

### 执行动作

1. 将 `reports/ai-replay-paths-*.txt` 扩充到不少于 `10` 条样本，覆盖至少三类失败场景（超时、网络、上游错误）。  
2. 执行周度复盘脚本：
   - `bash scripts/ops/ai-weekly-recap.sh --base-url http://localhost:8082 --paths-file ../reports/ai-replay-paths-2026-03-04.txt --date 2026-03-04`
3. 填写周度记录：
   - `docs/05-指标与评估/AI周度基线复盘-2026-03-04.md`
4. D5 复跑一轮并做周内对比，确认结果稳定。

### 验收口径

- `gates.allPassed=true`。  
- `degradedRatio <= 0.20`。  
- `structurePassRatio = 1.00`。  
- `errorClassCoverage = 1.00`（降级样本有明确分类）。

### 工作包 3：知识库回滚与控制台闭环复核（D6~D8）

### 要解决的问题

知识库失败回滚与控制台闭环已完成首轮，但缺少“按班次可复现”的固定复核节奏。

### 执行动作

1. 按手册重跑知识导入失败 A/B/C 三个场景，输出：
   - `reports/kb-failure-rollback-drill-2026-03-07.json`
2. 执行控制台闭环验收脚本：
   - `bash scripts/ops/console-closure-check.sh --base-url http://localhost:8082 --log-path <abs_log_path> --output-file ../reports/console-closure-check-2026-03-07.json`
3. 重点核对接口：
   - `GET /api/health`
   - `GET /api/dashboard`
   - `GET /api/dashboard?mode=light`

### 验收口径

- 三类知识导入失败场景均可复现、可回滚、可恢复。  
- `console-closure-check` 输出 `pass=true`。  
- `dashboard` 与 `dashboard?mode=light` 在未就绪场景仍返回 `200` 且结构可读。

### 工作包 4：最小安全与门禁回归（D9~D10）

### 要解决的问题

主线闭环稳定后，需要固定最小安全项和构建门禁，防止后续迭代出现隐性回退。

### 执行动作

1. 后端门禁：
   - `cd go-watch-file && go test ./... -count=1`
2. 前端门禁（macOS + nvm 口径）：
   - `source /etc/profile && node -v && npm -v`
   - `cd console-frontend && npm run build`
3. 固定回归点：
   - 路径越权与防穿越相关用例（`internal/pathutil`）
   - CORS 回归用例（`internal/api/server_cors_test.go`）
   - dashboard 降级相关用例（`internal/api/dashboard_handler_test.go`）

### 验收口径

- 后端测试与前端构建均通过。  
- 最小安全相关回归用例通过。  
- 文档引用与代码行为一致，无冲突描述。

## 3. 周结产物与收口动作

在 D10 统一输出阶段收口报告：

1. 聚合轻量复盘：
   - `bash scripts/ops/stage-recap-lite.sh --ai-baseline ../reports/ai-baseline-2026-03-04.json --kb-drill ../reports/kb-failure-rollback-drill-2026-03-07.json --console-check ../reports/console-closure-check-2026-03-07.json --output-file ../reports/stage-recap-2026-03-10-lite.json`
2. 形成周结文档：
   - `docs/05-指标与评估/阶段回归报告-2026-03-10.md`
3. 复核 `docs/04-路线图与计划/TODO.md` 中 P0 与周结结果一致。

## 4. 风险与应对

1. 风险：AI 样本扩容后门禁波动增大，导致周结失败。  
应对：保留 `--allow-gate-fail` 演练模式并记录失败分类，不直接删样本。

2. 风险：回归脚本依赖本地路径，跨机器执行失败。  
应对：所有命令统一使用“模板路径 + 实际绝对路径”双写法。

3. 风险：文档更新滞后，执行口径再次漂移。  
应对：每次脚本参数调整后，同步更新 `docs/00-文档治理/接口变更文档同步检查清单.md`。

## 5. 完成定义（本计划）

满足以下条件即视为本轮完成：

1. A 类核心脚本完成两轮回归并有产物归档。  
2. `go test ./...` 与 `npm run build` 本轮执行通过。  
3. `/api/health`、`/api/dashboard`、`/api/dashboard?mode=light`、`/metrics` 校验通过。  
4. 主线入口文档与“下一步开发计划”引用一致。  
5. 已输出阶段周结，可作为 P1 规划输入材料。
