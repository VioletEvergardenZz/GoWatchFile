# 上传可靠性演练运行手册

> 文档状态：兼容保留

- 更新时间：2026-02-17
- 目标：验证上传链路在高压与故障场景下可观测、可降级、可恢复
- 关联脚本：
  - `go-watch-file/scripts/ops/upload-stress.ps1`
  - `go-watch-file/scripts/ops/check-metrics.ps1`
  - `go-watch-file/scripts/ops/upload-recap.ps1`

## 1. 演练范围

- 队列饱和与熔断限流
- 上传失败重试与失败原因聚合
- `/metrics` 与 `/api/health` 指标一致性

## 2. 前置条件

1. 服务可访问：`http://localhost:8082`
2. 监控目录可写，且已开启自动上传
3. 已保存演练前配置快照（`config.yaml`、`.env`）
4. 建议优先使用一键复盘脚本，手工命令作为补充

### 2.1 一键复盘（推荐）

队列压测 + 可选故障窗口 + 恢复窗口，自动输出 JSON 与 Markdown：

```powershell
cd go-watch-file
powershell -ExecutionPolicy Bypass -File scripts/ops/upload-recap.ps1 `
  -BaseUrl http://localhost:8082 `
  -WatchDir D:\tmp\gwf-stress `
  -FaultMode manual `
  -SaturationCount 1200 `
  -FaultCount 400 `
  -RecoveryCount 300 `
  -OutputFile ../reports/upload-recap-result.json `
  -ReportFile ../docs/05-指标与评估/上传链路压测与故障注入报告-$(Get-Date -Format yyyy-MM-dd).md
```

说明：
- `FaultMode=manual`：脚本会在故障窗口等待，你可手工执行 OSS 抖动/网络超时注入动作。
- `FaultMode=command`：可通过 `-FaultStartCommand` 与 `-FaultRecoverCommand` 执行自动化注入与恢复。
- `FaultMode=none`：仅执行队列压测，不做故障注入。

## 3. 基线采集

```powershell
cd go-watch-file
powershell -ExecutionPolicy Bypass -File scripts/ops/check-metrics.ps1 -BaseUrl http://localhost:8082 -OutputFile ../reports/metrics-before.prom
curl http://localhost:8082/api/health
```

记录项：
- `queue`、`inFlight`
- `queueFullTotal`、`queueShedTotal`
- `uploadFailureTotal` 与 `failureReasons`

## 4. 场景 A：队列饱和压测

```powershell
cd go-watch-file
powershell -ExecutionPolicy Bypass -File scripts/ops/upload-stress.ps1 -WatchDir D:\tmp\gwf-stress -Count 3000 -IntervalMs 5 -MinBytes 1024 -MaxBytes 8192 -Prefix queue_saturation
```

观察重点：
- `gwf_upload_queue_length` 是否明显抬升
- `gwf_upload_queue_shed_total` 是否递增
- `gwf_upload_queue_full_total` 是否递增

通过标准（建议）：
- 服务无崩溃，接口持续可用
- 队列下降后系统可自行恢复到低位
- 指标存在且含义可解释

## 5. 场景 B：上传失败与重试

建议做法（二选一）：
1. 临时将 `OSS_ENDPOINT` 指向不可达地址后重启服务
2. 在网络层临时阻断到 OSS 的出网

执行 2~3 分钟后恢复网络或配置，继续观察 5 分钟。

观察重点：
- `gwf_upload_retry_total` 是否上升
- `gwf_upload_failure_total` 与 `gwf_upload_failure_reason_total` 是否有分类
- 恢复后 `gwf_upload_success_total` 是否继续增长

## 6. 演练后采集

```powershell
cd go-watch-file
powershell -ExecutionPolicy Bypass -File scripts/ops/check-metrics.ps1 -BaseUrl http://localhost:8082 -OutputFile ../reports/metrics-after.prom
curl http://localhost:8082/api/health
```

## 7. 输出物

1. `reports/upload-recap-result.json`
2. `docs/05-指标与评估/上传链路压测与故障注入报告-YYYY-MM-DD.md`（或自定义 `-ReportFile`）
3. `reports/metrics-upload-*.prom` 与 `reports/health-upload-*.json` 快照
4. 若使用手工命令：`reports/metrics-before.prom`、`reports/metrics-after.prom`

## 8. 回滚与收尾

1. 恢复演练前 `.env` 与 `config.yaml`
2. 清理压测目录（避免影响下一轮）
3. 确认 `queue=0` 且无持续失败增长

