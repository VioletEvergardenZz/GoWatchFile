# 告警规则双层模板手册

> 更新时间：2026-02-19  
> 适用范围：`go-watch-file` 告警决策模块（`/api/alert-rules`）

## 1. 目标

将告警规则模板收敛为两层结构，降低“每次新增场景都从零拼规则”的维护成本：

- 默认规则层（`defaultRules`）  
  负责全局通用规则，所有环境默认启用。
- 场景规则层（`scenarios`）  
  按场景拆分增量规则，按需组合，不污染基础规则。

最终发布到后端的仍是当前兼容结构：`defaults + escalation + rules`。

## 2. 模板与脚本位置

- 双层模板：`go-watch-file/deploy/alert/gwf-alert-rules-layered-template.json`
- 组合脚本：`go-watch-file/scripts/ops/alert-rules-compose.ps1`

## 3. 模板结构

```json
{
  "version": 1,
  "defaults": { "...": "..." },
  "escalation": { "...": "..." },
  "defaultRules": [ { "...": "..." } ],
  "scenarios": [
    {
      "id": "database",
      "title": "数据库与连接池",
      "rules": [ { "...": "..." } ]
    }
  ]
}
```

字段说明：

- `defaultRules`：默认基线规则，始终参与组合。
- `scenarios[].id`：场景唯一标识，用于脚本选择。
- `scenarios[].rules`：场景增量规则。

## 4. 场景清单（当前模板）

- `database`：数据库与连接池
- `upload`：上传与存储链路
- `ai`：AI 分析链路
- `control`：控制面任务执行

## 5. 使用方式

### 5.1 仅组合，不发布

```powershell
cd go-watch-file
powershell -ExecutionPolicy Bypass -File scripts/ops/alert-rules-compose.ps1 `
  -TemplateFile ./deploy/alert/gwf-alert-rules-layered-template.json `
  -Scenarios "database,upload,ai" `
  -OutputFile ../reports/alert-rules-composed.json
```

输出文件 `alert-rules-composed.json` 为后端兼容结构，可用于审阅和归档。

### 5.2 组合并直接发布到后端

```powershell
cd go-watch-file
powershell -ExecutionPolicy Bypass -File scripts/ops/alert-rules-compose.ps1 `
  -TemplateFile ./deploy/alert/gwf-alert-rules-layered-template.json `
  -Scenarios "database,upload,ai,control" `
  -Apply `
  -BaseUrl http://localhost:8082 `
  -OutputFile ../reports/alert-rules-composed.json
```

### 5.3 组合所有场景

```powershell
cd go-watch-file
powershell -ExecutionPolicy Bypass -File scripts/ops/alert-rules-compose.ps1 `
  -IncludeAllScenarios `
  -OutputFile ../reports/alert-rules-composed.json
```

## 6. 退出码约定

- `0`：成功
- `2`：模板或规则校验失败
- `3`：指定了不存在的场景 ID
- `4`：发布到 `/api/alert-rules` 失败

## 7. 变更建议

1. 先在模板中调整 `defaultRules`，保证基础规则稳定。  
2. 新业务场景优先新增到 `scenarios`，避免直接污染默认层。  
3. 每次发布前先输出组合结果到 `reports/`，走 review 后再 `-Apply`。  
4. 模板变更需同步更新本手册中的“场景清单”与示例命令。
