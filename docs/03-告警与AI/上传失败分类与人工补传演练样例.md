# 上传失败分类与人工补传演练样例

> 文档状态：兼容保留
> 更新时间：2026-02-24
> 适用范围：`go-watch-file` 上传链路（Watcher -> Queue -> Worker -> OSS）

## 1. 目标

补齐“上传失败分类 + 人工补传”的最小演练样例，确保值班场景可以快速回答三个问题：

1. 当前失败主要是哪一类
2. 该类失败应先恢复什么前置条件
3. 前置条件恢复后如何执行人工补传并确认恢复

## 2. 演练前准备

1. 服务可访问：`http://localhost:8082`
2. 准备一批可重试样本文件（建议 10~30 个）
3. 记录基线：

```powershell
cd go-watch-file
powershell -ExecutionPolicy Bypass -File scripts/ops/check-metrics.ps1 -BaseUrl http://localhost:8082 -OutputFile ../reports/metrics-upload-before.prom
curl http://localhost:8082/api/health
```

建议重点关注：
- `gwf_upload_failure_total`
- `gwf_upload_failure_reason_total`
- `gwf_upload_retry_total`
- `/api/health` 中 `failureReasons`

## 3. 常见失败分类与处理动作

以下分类用于值班排障，具体 reason 文案以运行时指标与日志为准

| 失败分类 | 典型现象 | 首要处理动作 | 人工补传前检查 |
| --- | --- | --- | --- |
| 队列容量不足 | 出现 `upload queue full` | 调大 `upload_queue_size` 或降低写入速率 | `queue` 和 `inFlight` 已回落 |
| 队列饱和限流 | 出现 `upload queue saturated` | 调整 `upload_queue_saturation_threshold` 或临时扩容 worker | `queueShedTotal` 停止快速增长 |
| OSS 连接异常 | endpoint 不可达、TLS 或 DNS 异常 | 修复 `OSS_ENDPOINT`、网络与证书 | 手工 `curl`/连通性检查通过 |
| 鉴权/权限异常 | AK/SK 无效或 bucket 权限不足 | 修复 `OSS_AK/OSS_SK` 与权限策略 | 先用单文件验证权限 |
| 本地文件异常 | 文件被删除、无读权限、路径非法 | 修复文件权限或替换样本路径 | 文件可被进程读取 |

## 4. 人工补传演练步骤

### 4.1 触发失败样本

可通过以下方式制造失败窗口：
- 临时设置不可达 `OSS_ENDPOINT`
- 临时阻断到 OSS 的网络
- 压测导致队列打满

使用 `upload-stress.ps1` 生成样本：

```powershell
cd go-watch-file
powershell -ExecutionPolicy Bypass -File scripts/ops/upload-stress.ps1 -WatchDir D:\tmp\gwf-stress -Count 200 -IntervalMs 10 -Prefix retry_case
```

### 4.2 恢复前置条件

按第 3 节对应分类先恢复网络、权限、配置或容量，确认失败原因不再持续增长

### 4.3 执行人工补传

对失败文件逐个触发人工补传：

```powershell
Invoke-RestMethod -Method Post -Uri "http://localhost:8082/api/manual-upload" -ContentType "application/json" -Body '{"path":"D:\\tmp\\gwf-stress\\retry_case-0001.log"}'
```

可批量循环执行（示例）：

```powershell
$files = Get-ChildItem D:\tmp\gwf-stress -Filter "retry_case-*.log" | Select-Object -First 20
foreach ($f in $files) {
  $body = @{ path = $f.FullName } | ConvertTo-Json
  Invoke-RestMethod -Method Post -Uri "http://localhost:8082/api/manual-upload" -ContentType "application/json" -Body $body | Out-Null
}
```

### 4.4 确认恢复

```powershell
cd go-watch-file
powershell -ExecutionPolicy Bypass -File scripts/ops/check-metrics.ps1 -BaseUrl http://localhost:8082 -OutputFile ../reports/metrics-upload-after-manual.prom
curl http://localhost:8082/api/health
```

验收建议：
- `gwf_upload_success_total` 持续增长
- `gwf_upload_failure_reason_total` 不再出现同类快速增长
- `queue` 回到低位且 `inFlight` 可清空

## 5. 建议输出物

1. `reports/metrics-upload-before.prom`
2. `reports/metrics-upload-after-manual.prom`
3. `reports/health-upload-before.json` 与 `reports/health-upload-after.json`
4. 演练结论记录（失败分类、恢复动作、补传结果）

## 6. 关联文档

- `docs/03-告警与AI/上传可靠性演练手册.md`
- `docs/02-开发运维/常见问题.md`
- `docs/05-指标与评估/监控指标字典-v1.md`

