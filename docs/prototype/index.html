<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>单机文件监控 Agent 控制台 · 原型</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600&family=Manrope:wght@500;600&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      --bg: #080d15;
      --panel: rgba(13, 17, 26, 0.94);
      --panel-strong: rgba(14, 21, 34, 0.96);
      --border: #1f2937;
      --accent: #f97316;
      --accent2: #22d3ee;
      --muted: #94a3b8;
      --text: #e5e7eb;
      --success: #34d399;
      --warning: #f59e0b;
      --danger: #f43f5e;
      --card-glow: 0 24px 90px rgba(249, 115, 22, 0.08);
    }

    html { scroll-behavior: smooth; }
    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: "Space Grotesk", "Manrope", "Helvetica Neue", Arial, sans-serif;
      background:
        radial-gradient(circle at 10% 18%, rgba(34, 211, 238, 0.12), transparent 28%),
        radial-gradient(circle at 90% 12%, rgba(249, 115, 22, 0.12), transparent 32%),
        linear-gradient(135deg, #0b1020, #0b1224 45%, #0a0f1a),
        var(--bg);
      color: var(--text);
      min-height: 100vh;
    }

    .layout { display: grid; grid-template-columns: 240px 1fr; gap: 16px; max-width: 1480px; margin: 0 auto; padding: 22px 18px 42px; align-items: start; }
    .sidebar { background: var(--panel-strong); border: 1px solid var(--border); border-radius: 18px; padding: 14px; position: sticky; top: 18px; height: fit-content; box-shadow: var(--card-glow); }
    .nav-brand { display: flex; align-items: center; gap: 10px; margin-bottom: 8px; }
    .brand-badge.small { width: 42px; height: 42px; font-size: 14px; }
    .nav-title { font-weight: 700; letter-spacing: 0.2px; }
    .nav-sub { color: var(--muted); font-size: 12px; }
    .nav-meta { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 12px; align-items: center; }
    .nav-list { display: grid; gap: 6px; margin: 0 0 12px 0; padding: 0; list-style: none; }
    .nav-item { display: flex; justify-content: space-between; align-items: center; padding: 9px 10px; border-radius: 10px; border: 1px solid var(--border); background: rgba(10,14,22,0.8); color: var(--text); text-decoration: none; transition: all 0.15s ease; font-weight: 700; letter-spacing: 0.2px; }
    .nav-item small { color: var(--muted); font-weight: 500; }
    .nav-item:hover { border-color: var(--accent); background: rgba(14,19,30,0.95); }
    .nav-item.active { background: linear-gradient(135deg, rgba(249,115,22,0.08), rgba(34,211,238,0.08)); border-color: var(--accent); box-shadow: var(--card-glow); }
    .nav-foot { border-top: 1px solid var(--border); padding-top: 10px; display: grid; gap: 8px; }
    .nav-foot-row { display: flex; justify-content: space-between; align-items: center; color: var(--muted); font-size: 12px; }
    .page { max-width: 1280px; margin: 0 auto; padding: 26px 20px 48px; }

    header {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: space-between;
      gap: 14px;
      margin-bottom: 16px;
    }

    .brand { display: flex; align-items: center; gap: 12px; }

    .brand-badge {
      width: 46px; height: 46px; border-radius: 15px;
      background: linear-gradient(135deg, #f97316, #f43f5e);
      display: grid; place-items: center;
      font-weight: 700; color: #0c111b;
      box-shadow: 0 12px 50px rgba(244, 63, 94, 0.35);
    }

    .title h1 { margin: 0; font-size: 21px; letter-spacing: 0.4px; }
    .title p { margin: 4px 0 0; color: var(--muted); font-size: 14px; }

    .controls { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; }

    .btn {
      display: inline-flex; align-items: center; gap: 8px;
      background: linear-gradient(135deg, #f97316, #f43f5e);
      color: #0c111b; border: none; border-radius: 12px;
      padding: 10px 13px; font-weight: 700; cursor: pointer;
      box-shadow: var(--card-glow);
      transition: transform 0.15s ease;
    }
    .btn.secondary { background: var(--panel); border: 1px solid var(--border); color: var(--text); box-shadow: none; }
    .btn:hover { transform: translateY(-1px); }
    .btn svg { width: 16px; height: 16px; }

    .chip {
      border: 1px solid var(--border); background: var(--panel);
      color: var(--text); padding: 7px 11px; border-radius: 11px;
      font-weight: 600; letter-spacing: 0.2px; cursor: pointer;
      transition: all 0.2s ease;
    }
    .chip.active { border-color: var(--accent); background: linear-gradient(135deg, rgba(249,115,22,0.18), rgba(34,211,238,0.12)); box-shadow: var(--card-glow); }

    .hero {
      background: linear-gradient(135deg, rgba(249, 115, 22, 0.14), rgba(34, 211, 238, 0.12));
      border: 1px solid var(--border); border-radius: 18px;
      padding: 16px; margin-bottom: 12px; box-shadow: var(--card-glow);
      display: grid; grid-template-columns: 2fr 1fr; gap: 14px;
    }

    .hero strong { color: #fff; }

    .hero-list { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 8px; }
    .hero-list span { background: rgba(12, 16, 26, 0.6); border: 1px solid var(--border); border-radius: 10px; padding: 8px 10px; font-weight: 600; }

    .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(170px, 1fr)); gap: 12px; margin-bottom: 12px; }

    .card { background: var(--panel); border: 1px solid var(--border); border-radius: 14px; padding: 12px 12px 14px; box-shadow: var(--card-glow); }
    .card small { color: var(--muted); display: block; margin-bottom: 6px; }
    .value { font-size: 24px; font-weight: 700; display: flex; gap: 6px; align-items: baseline; }
    .trend { font-size: 12px; color: var(--muted); }
    .trend.up { color: var(--success); } .trend.down { color: var(--danger); }

    .panel { background: var(--panel-strong); border: 1px solid var(--border); border-radius: 16px; padding: 14px; box-shadow: var(--card-glow); }
    .section-title { display: flex; justify-content: space-between; align-items: center; margin: 0 0 10px; gap: 8px; }
    .section-title h2 { margin: 0; font-size: 15px; }
    .section-title span { color: var(--muted); font-size: 13px; }

    .flex-2 { display: grid; grid-template-columns: 1.1fr 1fr; gap: 12px; }

    table { width: 100%; border-collapse: collapse; color: var(--text); font-size: 14px; }
    th, td { text-align: left; padding: 8px 6px; border-bottom: 1px solid var(--border); }
    th { color: var(--muted); font-weight: 500; }

    .toolbar { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; margin-bottom: 8px; }
    .search { padding: 9px 10px; border-radius: 10px; border: 1px solid var(--border); background: rgba(255,255,255,0.04); color: var(--text); min-width: 220px; }
    .select { padding: 9px 10px; border-radius: 10px; border: 1px solid var(--border); background: rgba(255,255,255,0.05); color: var(--text); min-width: 220px; }

    .badge { background: rgba(255,255,255,0.06); border: 1px solid var(--border); padding: 5px 8px; border-radius: 9px; font-size: 12px; display: inline-block; }
    .pill { border-radius: 999px; padding: 5px 9px; font-size: 12px; color: #0c111b; font-weight: 700; }
    .pill.success { background: #34d399; }
    .pill.warning { background: #f59e0b; }
    .pill.danger { background: #f43f5e; }
    .pill.info { background: #93c5fd; }

    .tail-box { background: rgba(0,0,0,0.35); border: 1px solid var(--border); border-radius: 12px; padding: 10px; font-family: "IBM Plex Mono", Consolas, monospace; font-size: 12px; color: #d1d5db; height: 180px; overflow: auto; line-height: 1.5; }
    .timeline { display: grid; gap: 7px; margin-top: 8px; }
    .timeline-item { display: grid; grid-template-columns: auto 1fr auto; gap: 10px; align-items: center; }

    .inputs { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 8px; }
    .input { display: flex; flex-direction: column; gap: 5px; }
    .input label { color: var(--muted); font-size: 13px; }
    .input input, .input select { background: rgba(255,255,255,0.05); border: 1px solid var(--border); border-radius: 10px; padding: 9px 10px; color: var(--text); }
    .input input:focus, .input select:focus { border-color: var(--accent); box-shadow: 0 0 0 2px rgba(249,115,22,0.2); outline: none; }

    .chart-wrapper { position: relative; height: 220px; }

    .stack { display: grid; gap: 10px; }
    .stack-item { border: 1px solid var(--border); border-radius: 12px; padding: 10px; background: rgba(255,255,255,0.02); }

    .workspace { display: grid; grid-template-columns: minmax(360px, 0.9fr) 1.1fr; gap: 12px; align-items: stretch; }
    .tree-panel { display: flex; flex-direction: column; gap: 10px; }
    .tree { border: 1px solid var(--border); border-radius: 12px; background: rgba(255,255,255,0.03); padding: 10px; max-height: 440px; overflow: auto; box-shadow: inset 0 1px 0 rgba(255,255,255,0.02); }
    .tree-item { display: block; }
    .tree-row { position: relative; display: grid; grid-template-columns: auto 1fr auto; gap: 10px; align-items: center; padding: 9px 10px; border-radius: 10px; border: 1px solid transparent; background: rgba(10,13,21,0.8); cursor: pointer; transition: border-color 0.15s ease, background 0.15s ease; }
    .tree-row:hover { border-color: var(--border); background: rgba(14,19,30,0.95); }
    .tree-row.active { border-color: var(--accent); box-shadow: 0 10px 30px rgba(249,115,22,0.15); background: linear-gradient(135deg, rgba(249,115,22,0.08), rgba(34,211,238,0.08)); }
    .tree-children { margin-left: 14px; border-left: 1px dashed var(--border); padding-left: 10px; }
    .node-head { display: flex; align-items: center; gap: 8px; min-width: 46px; }
    .node-icon { width: 12px; height: 12px; border-radius: 4px; background: var(--border); box-shadow: inset 0 0 0 1px rgba(255,255,255,0.05); }
    .node-icon.dir { background: linear-gradient(135deg, rgba(249,115,22,0.45), rgba(34,211,238,0.45)); }
    .node-icon.file { background: rgba(255,255,255,0.1); }
    .node-body { display: grid; gap: 4px; }
    .node-title { font-weight: 700; }
    .node-sub { color: var(--muted); font-size: 12px; }
    .collapse-btn { background: rgba(255,255,255,0.06); border: 1px solid var(--border); color: var(--text); border-radius: 8px; padding: 5px 8px; cursor: pointer; font-weight: 600; font-size: 12px; }
    .collapse-btn:hover { border-color: var(--accent); }
    .node-actions { display: inline-flex; align-items: center; gap: 8px; }
    .switch { position: relative; display: inline-block; width: 38px; height: 20px; }
    .switch input { opacity: 0; width: 0; height: 0; }
    .switch .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #1f2937; transition: .2s; border-radius: 999px; }
    .switch .slider:before { position: absolute; content: ""; height: 14px; width: 14px; left: 3px; bottom: 3px; background-color: white; transition: .2s; border-radius: 50%; }
    .switch input:checked + .slider { background: linear-gradient(135deg, #f97316, #22d3ee); box-shadow: var(--card-glow); }
    .switch input:checked + .slider:before { transform: translateX(18px); }
    .switch.mini { width: 32px; height: 18px; }
    .switch.mini .slider:before { height: 12px; width: 12px; bottom: 3px; }
    .switch-group { display: flex; align-items: center; gap: 10px; flex-wrap: wrap; justify-content: flex-end; }

    .file-preview { background: var(--panel); border: 1px solid var(--border); border-radius: 14px; padding: 12px; box-shadow: var(--card-glow); display: flex; flex-direction: column; gap: 10px; }
    .preview-header { display: flex; justify-content: space-between; align-items: flex-start; gap: 10px; }
    .preview-title { font-size: 16px; font-weight: 700; margin: 4px 0; }
    .preview-path { color: var(--muted); font-size: 13px; }
    .preview-meta { color: var(--muted); font-size: 13px; display: flex; gap: 10px; flex-wrap: wrap; }
    .preview-content { background: #05080f; border: 1px solid var(--border); border-radius: 12px; padding: 12px; min-height: 240px; max-height: 340px; overflow: auto; font-family: "IBM Plex Mono", Consolas, monospace; font-size: 12px; line-height: 1.5; color: #d1d5db; }

    @media (max-width: 1120px) { .layout { grid-template-columns: 1fr; } .hero { grid-template-columns: 1fr; } .flex-2 { grid-template-columns: 1fr; } .workspace { grid-template-columns: 1fr; } .sidebar { position: static; } }
  </style>
</head>
<body>
  <div class="layout">
    <aside class="sidebar">
      <div class="nav-brand">
        <div class="brand-badge small">FW</div>
        <div>
          <div class="nav-title">File Watch</div>
          <div class="nav-sub">单机 Agent 控制台</div>
        </div>
      </div>
      <div class="nav-meta">
        <span class="pill success">运行中</span>
        <span class="badge">srv-01</span>
        <span class="badge">全量监控</span>
      </div>
      <nav class="nav-list" id="sideNav">
        <a class="nav-item active" href="#overview"><span>总览</span><small>心跳 / 摘要</small></a>
        <a class="nav-item" href="#directory"><span>目录浏览</span><small>自动上传</small></a>
        <a class="nav-item" href="#files"><span>文件列表</span><small>CRUD</small></a>
        <a class="nav-item" href="#tail"><span>Tail / 配置</span><small>实时</small></a>
        <a class="nav-item" href="#failures"><span>失败重试</span><small>队列</small></a>
        <a class="nav-item" href="#monitor"><span>监控</span><small>吞吐</small></a>
      </nav>
      <div class="nav-foot">
        <div class="nav-foot-row"><span>后缀过滤</span><span class="pill warning">关闭</span></div>
        <div class="nav-foot-row"><span>目录递归</span><span class="pill success">开启</span></div>
        <div class="nav-foot-row">
          <span>自动刷新</span>
          <label class="switch mini">
            <input type="checkbox" checked>
            <span class="slider"></span>
          </label>
        </div>
        <div class="nav-foot-row"><span>上传并发</span><span class="badge">8 workers</span></div>
      </div>
    </aside>
    <div class="page">
      <header>
        <div class="brand">
          <div class="brand-badge">FW</div>
          <div class="title">
            <h1>单机文件监控 Agent 控制台</h1>
            <p>针对当前主机的目录监听、上云、路由与告警视图</p>
          </div>
        </div>
        <div class="controls">
          <div class="chip active">实时</div>
          <div class="chip">最近 24h</div>
          <button class="btn secondary" type="button">重载配置</button>
          <button class="btn" type="button">手动上传/同步</button>
        </div>
      </header>

      <div id="overview" class="stack" style="gap: 12px;">
        <div class="hero">
          <div>
            <div style="font-size:16px;font-weight:700; margin-bottom:6px;">当前 Agent：<strong>srv-01</strong></div>
            <div style="color:var(--text); opacity:0.85; line-height:1.5;">
              监听目录 <strong>/data/logs/app</strong> ，后缀过滤已关闭（全量监控）；静默窗口 4s，队列 200，上传并发 8，目标存储 <strong>s3://logs-warm</strong>。
              单机视角：本地主机事件、队列、告警与上云进度一屏掌握，目录树可逐个文件关闭自动上传。
            </div>
          </div>
          <div class="hero-list">
            <span>静默判定防半截</span>
            <span>S3/OSS 路径防穿越</span>
            <span>上传并发 + 背压</span>
            <span>失败重试/隔离</span>
            <span>企微/钉钉告警</span>
          </div>
        </div>

        <section class="grid">
          <div class="card"><small>运行状态</small><div class="value">Running <span class="trend up">心跳正常</span></div></div>
          <div class="card"><small>今日上传</small><div class="value">248 <span class="trend up">+12%</span></div></div>
          <div class="card"><small>失败率</small><div class="value">1.4% <span class="trend down">-0.3%</span></div></div>
          <div class="card"><small>队列深度</small><div class="value">32 <span class="trend warning">背压监控</span></div></div>
          <div class="card"><small>平均耗时</small><div class="value">820 ms <span class="trend up">-90 ms</span></div></div>
          <div class="card"><small>通知发送</small><div class="value">9 <span class="trend up">全部成功</span></div></div>
        </section>
      </div>

      <section class="panel" id="directory" style="margin-bottom: 10px;">
        <div class="section-title"><h2>目录浏览 / 自动上传控制</h2><span>全量目录监控 · 后缀匹配已关闭</span></div>
        <div class="workspace">
          <div class="tree-panel">
            <div class="toolbar">
              <select class="select" id="rootSelect"></select>
              <div class="chip active">递归监听</div>
              <div class="chip">仅新文件</div>
              <span class="badge">自动刷新</span>
              <button class="btn secondary" type="button" id="collapseAll" style="padding:7px 10px;">全部收起</button>
              <button class="btn secondary" type="button" id="expandAll" style="padding:7px 10px;">全部展开</button>
            </div>
            <div class="tree" id="dirTree"></div>
          </div>
          <div class="file-preview">
            <div class="preview-header">
              <div>
                <span class="pill success" id="previewState">自动上传开启</span>
                <div class="preview-title" id="previewTitle">app-2024-12-26.log</div>
                <div class="preview-path" id="previewPath">/data/logs/app/app-2024-12-26.log</div>
              </div>
              <div class="switch-group">
                <span style="color:var(--muted); font-size:13px;">自动上传</span>
                <label class="switch" aria-label="auto upload toggle">
                  <input type="checkbox" id="previewAutoToggle" checked>
                  <span class="slider"></span>
                </label>
                <button class="btn secondary" type="button" id="previewUploadBtn" style="padding:7px 10px;">立即上传</button>
              </div>
            </div>
            <div class="preview-meta" id="previewMeta"></div>
            <div class="preview-content" id="previewContent"></div>
          </div>
        </div>
      </section>

    <section class="panel" id="files" style="margin-bottom: 10px;">
      <div class="section-title"><h2>文件列表（单机 CRUD）</h2><span>查看 / 下载 / 删除 / 重试</span></div>
      <div class="toolbar">
        <input class="search" placeholder="搜索文件名 / 路径">
        <div class="chip active">全部</div>
        <div class="chip">自动上传</div>
        <div class="chip">手动上传</div>
        <div class="chip">需审批</div>
        <div class="chip">失败</div>
        <span class="badge">后缀过滤已关闭 · 按目录控制</span>
        <button class="btn secondary" type="button" style="padding:7px 10px;">批量删除</button>
      </div>
      <table id="fileTable"></table>
    </section>

    <section class="flex-2" id="tail" style="margin-bottom: 10px;">
      <div class="panel">
        <div class="section-title"><h2>实时 Tail / 关键字</h2><span>最近 200 行</span></div>
        <div class="toolbar">
          <div class="chip active">实时</div>
          <div class="chip">仅错误</div>
          <div class="chip">下载原文件</div>
        </div>
        <div class="tail-box" id="tailBox"></div>
        <div class="timeline" id="timeline"></div>
      </div>
      <div class="panel">
        <div class="section-title"><h2>上传与路由配置（本机）</h2><span>表单仅为演示</span></div>
        <div class="inputs">
          <div class="input"><label>watch_dir</label><input value="/data/logs/app , /data/etl/raw"/></div>
          <div class="input"><label>后缀过滤</label><input value="关闭 · 全量目录"/></div>
          <div class="input"><label>静默窗口</label><input value="4s"/></div>
          <div class="input"><label>并发/队列</label><input value="workers=8 / queue=200"/></div>
          <div class="input"><label>S3 目标</label><input value="s3://logs-warm"/></div>
          <div class="input"><label>目录策略</label><input value="按目录树开关自动上传"/></div>
          <div class="input"><label>Action</label><select><option>上传 + Webhook</option><option>上传 + 队列</option><option>隔离 + 审核</option></select></div>
        </div>
        <div class="toolbar" style="justify-content: space-between; margin-top:8px;">
          <span class="badge">路径校验已启用 · 防穿越</span>
          <button class="btn" type="button" style="padding:8px 12px;">预览路由</button>
        </div>
        <div class="stack" id="routePreview"></div>
      </div>
    </section>

    <section class="panel" id="failures" style="margin-bottom: 10px;">
      <div class="section-title"><h2>失败 / 重试 / 告警</h2><span>单机队列</span></div>
      <table id="failureTable"></table>
    </section>

    <section class="panel" id="monitor">
      <div class="section-title"><h2>运行与上云监控</h2><span>吞吐 / 队列 / 时延</span></div>
      <div class="flex-2" style="align-items: stretch;">
        <div class="chart-wrapper"><canvas id="throughputChart"></canvas></div>
        <div class="stack">
          <div class="stack-item"><strong>S3 连接</strong><div class="meta">endpoint=minio.local · force_path_style=true · region=us-east-1</div></div>
          <div class="stack-item"><strong>上传工作池</strong><div class="meta">workers=8 · queue=200 · 当前 backlog=32</div></div>
          <div class="stack-item"><strong>通知</strong><div class="meta">钉钉机器人已配置 · 失败自动重试 3 次</div></div>
        </div>
      </div>
    </section>
  </div>
</div>

  <script>
    const fmt = (t) => {
      const today = new Date().toISOString().split("T")[0];
      return `${today} ${t}`;
    };

    const navItems = Array.from(document.querySelectorAll("#sideNav .nav-item"));
    const sectionIds = ["overview", "directory", "files", "tail", "failures", "monitor"];
    const sections = sectionIds.map(id => document.getElementById(id)).filter(Boolean);

    const setActiveNav = (id) => {
      navItems.forEach((item) => {
        const href = item.getAttribute("href") || "";
        const target = href.replace("#", "");
        item.classList.toggle("active", target === id);
      });
    };

    if (navItems.length && sections.length) {
      navItems.forEach((item) => {
        item.addEventListener("click", () => setActiveNav((item.getAttribute("href") || "").replace("#", "")));
      });
      const syncNavByScroll = () => {
        const offset = 140;
        let current = sections[0].id;
        sections.forEach((sec) => {
          const rect = sec.getBoundingClientRect();
          if (rect.top <= offset) {
            current = sec.id;
          }
        });
        setActiveNav(current);
      };
      window.addEventListener("scroll", syncNavByScroll);
      syncNavByScroll();
    }

    const directoryTree = [
      {
        name: "/data/logs/app",
        path: "/data/logs/app",
        type: "dir",
        autoUpload: true,
        children: [
          {
            name: "app-2024-12-26.log",
            path: "/data/logs/app/app-2024-12-26.log",
            type: "file",
            size: "14.2 MB",
            updated: "10:32:10",
            autoUpload: true,
            content: `[INFO] app start
[INFO] upload success key=logs/2024/12/26/app.log
[INFO] latency=640ms route=logs-warm`
          },
          {
            name: "heap-2024-12-26.hprof",
            path: "/data/logs/app/heap-2024-12-26.hprof",
            type: "file",
            size: "1.2 GB",
            updated: "10:31:45",
            autoUpload: false,
            content: `自动上传关闭 · 需审批
size=1.2GB · md5 pending`
          },
          {
            name: "archived",
            path: "/data/logs/app/archived",
            type: "dir",
            autoUpload: false,
            children: [
              {
                name: "trace-2024-12-24.log",
                path: "/data/logs/app/archived/trace-2024-12-24.log",
                type: "file",
                size: "4.2 MB",
                updated: "10:20:12",
                autoUpload: false,
                content: `[TRACE] archived trace sample
lines=120`
              },
              {
                name: "trace-2024-12-25.log",
                path: "/data/logs/app/archived/trace-2024-12-25.log",
                type: "file",
                size: "4.5 MB",
                updated: "10:28:18",
                autoUpload: true,
                content: `[TRACE] archived trace upload allowed
lines=128`
              }
            ]
          }
        ]
      },
      {
        name: "/data/etl/raw",
        path: "/data/etl/raw",
        type: "dir",
        autoUpload: true,
        children: [
          {
            name: "etl-raw-2024-12-26-01.csv",
            path: "/data/etl/raw/etl-raw-2024-12-26-01.csv",
            type: "file",
            size: "8.6 MB",
            updated: "10:31:58",
            autoUpload: true,
            content: `id,value
1,foo
2,bar`
          },
          {
            name: "etl-raw-2024-12-26-02.csv",
            path: "/data/etl/raw/etl-raw-2024-12-26-02.csv",
            type: "file",
            size: "9.1 MB",
            updated: "10:29:31",
            autoUpload: true,
            content: `id,value
3,baz
4,qux`
          },
          {
            name: "error-2024-12-26.tar.gz",
            path: "/data/etl/raw/error-2024-12-26.tar.gz",
            type: "file",
            size: "380 MB",
            updated: "10:30:02",
            autoUpload: false,
            content: "自动上传关闭 · 手动审核后再入云"
          }
        ]
      }
    ];

    const findFirstFile = (nodes) => {
      for (const node of nodes) {
        if (node.type === "file") return node;
        if (node.children) {
          const found = findFirstFile(node.children);
          if (found) return found;
        }
      }
      return null;
    };

    const findNodeByPath = (nodes, path) => {
      for (const node of nodes) {
        if (node.path === path) return node;
        if (node.children) {
          const found = findNodeByPath(node.children, path);
          if (found) return found;
        }
      }
      return null;
    };

    const propagateAuto = (node, value) => {
      node.autoUpload = value;
      if (node.children) {
        node.children.forEach((child) => propagateAuto(child, value));
      }
    };

    const setAutoUpload = (nodes, path, value) => {
      for (const node of nodes) {
        if (node.path === path) {
          propagateAuto(node, value);
          return true;
        }
        if (node.children && setAutoUpload(node.children, path, value)) {
          return true;
        }
      }
      return false;
    };

    const collapsedPaths = new Set();
    let currentRootPath = directoryTree[0]?.path || "";

    const getRootNodes = () => directoryTree.filter((n) => n.path === currentRootPath);

    const renderTreeNode = (node, depth, activePath) => {
      const isFile = node.type === "file";
      const isActive = isFile && node.path === activePath;
      const pillClass = node.autoUpload ? "success" : "warning";
      const pillText = node.autoUpload ? "自动" : "手动";
      const meta = isFile ? `${node.size} · 更新 ${node.updated}` : `${(node.children?.length || 0)} 项 · 层级 ${depth + 1}`;
      const isCollapsed = collapsedPaths.has(node.path);
      return `
        <div class="tree-item">
          <div class="tree-row ${isActive ? "active" : ""}" style="padding-left:${depth * 10 + 6}px" data-path="${node.path}" data-type="${node.type}">
            <div class="node-head">
              <span class="node-icon ${isFile ? "file" : "dir"}"></span>
              <span class="pill ${isFile ? "info" : "success"}" style="padding:4px 8px; font-size:11px;">${isFile ? "FILE" : "DIR"}</span>
            </div>
            <div class="node-body">
              <div class="node-title">${node.name}</div>
              <div class="node-sub">${node.path}</div>
              <div class="node-sub" style="opacity:0.9;">${meta}</div>
            </div>
            <div class="node-actions">
              ${!isFile ? `<button class="collapse-btn" data-path="${node.path}" data-collapse="${isCollapsed ? "expand" : "collapse"}">${isCollapsed ? "展开" : "收起"}</button>` : ""}
              <span class="pill ${pillClass}">${pillText}</span>
              <label class="switch mini">
                <input type="checkbox" class="auto-toggle" data-path="${node.path}" ${node.autoUpload ? "checked" : ""}>
                <span class="slider"></span>
              </label>
            </div>
          </div>
          ${node.children && !isCollapsed ? `<div class="tree-children">${node.children.map(child => renderTreeNode(child, depth + 1, activePath)).join('')}</div>` : ""}
        </div>
      `;
    };

    const dirTreeEl = document.getElementById("dirTree");
    const rootSelect = document.getElementById("rootSelect");
    const previewState = document.getElementById("previewState");
    const previewTitle = document.getElementById("previewTitle");
    const previewPath = document.getElementById("previewPath");
    const previewMeta = document.getElementById("previewMeta");
    const previewContent = document.getElementById("previewContent");
    const previewAutoToggle = document.getElementById("previewAutoToggle");
    const previewUploadBtn = document.getElementById("previewUploadBtn");
    const collapseAllBtn = document.getElementById("collapseAll");
    const expandAllBtn = document.getElementById("expandAll");

    let selectedFilePath = findFirstFile(getRootNodes())?.path || "";

    function renderPreview(node) {
      if (!previewState || !previewTitle) return;
      if (!node || node.type !== "file") {
        previewState.className = "pill info";
        previewState.textContent = "选择一个文件";
        previewTitle.textContent = "未选择文件";
        previewPath.textContent = "—";
        previewMeta.textContent = "目录树展示全部文件，可切换自动上传";
        previewContent.textContent = "点击左侧目录树中的文件预览内容。";
        if (previewAutoToggle) {
          previewAutoToggle.checked = false;
        }
        return;
      }
      previewState.className = node.autoUpload ? "pill success" : "pill warning";
      previewState.textContent = node.autoUpload ? "自动上传开启" : "自动上传关闭";
      previewTitle.textContent = node.name;
      previewPath.textContent = node.path;
      previewMeta.textContent = `大小 ${node.size} · 更新 ${fmt(node.updated)} · 目录监控中`;
      previewContent.textContent = node.content || "文件内容预览";
      if (previewAutoToggle) {
        previewAutoToggle.checked = node.autoUpload;
      }
    }

    const renderDirTree = () => {
      if (!dirTreeEl) return;
      const roots = getRootNodes();
      dirTreeEl.innerHTML = roots.map((node) => renderTreeNode(node, 0, selectedFilePath)).join("");
    };

    const refreshSelectionForRoot = () => {
      const first = findFirstFile(getRootNodes());
      selectedFilePath = first ? first.path : "";
      renderDirTree();
      renderPreview(findNodeByPath(directoryTree, selectedFilePath));
      renderFileTable(currentRootPath);
    };

    if (rootSelect) {
      rootSelect.innerHTML = directoryTree.map((n) => `<option value="${n.path}">${n.path}</option>`).join("");
      rootSelect.value = currentRootPath;
      rootSelect.addEventListener("change", (e) => {
        currentRootPath = e.target.value;
        collapsedPaths.clear();
        refreshSelectionForRoot();
      });
    }

    renderDirTree();
    renderPreview(findNodeByPath(directoryTree, selectedFilePath));

    const toggleDirCollapse = (path, collapse) => {
      if (collapse) {
        collapsedPaths.add(path);
      } else {
        collapsedPaths.delete(path);
      }
      renderDirTree();
    };

    const markAllDirs = (collapse) => {
      const walk = (nodes) => {
        nodes.forEach((n) => {
          if (n.type === "dir") {
            if (collapse) collapsedPaths.add(n.path); else collapsedPaths.delete(n.path);
          }
          if (n.children) walk(n.children);
        });
      };
      walk(getRootNodes());
      renderDirTree();
    };

    if (collapseAllBtn) collapseAllBtn.addEventListener("click", () => markAllDirs(true));
    if (expandAllBtn) expandAllBtn.addEventListener("click", () => markAllDirs(false));

    if (dirTreeEl) {
      dirTreeEl.addEventListener("click", (e) => {
        if (e.target.classList.contains("collapse-btn")) {
          const path = e.target.dataset.path;
          const mode = e.target.dataset.collapse;
          toggleDirCollapse(path, mode === "collapse");
          return;
        }
        if (e.target.closest(".auto-toggle")) return;
        const row = e.target.closest(".tree-row");
        if (!row) return;
        const path = row.dataset.path;
        const node = findNodeByPath(directoryTree, path);
        if (!node) return;
        if (node.type === "file") {
          selectedFilePath = node.path;
          renderDirTree();
          renderPreview(node);
        } else if (node.children) {
          const next = findFirstFile(node.children);
          if (next) {
            selectedFilePath = next.path;
            renderDirTree();
            renderPreview(next);
          }
        }
      });
      dirTreeEl.addEventListener("change", (e) => {
        if (!e.target.classList.contains("auto-toggle")) return;
        const path = e.target.dataset.path;
        const isOn = e.target.checked;
        setAutoUpload(directoryTree, path, isOn);
        const current = findNodeByPath(directoryTree, selectedFilePath);
        renderPreview(current);
        renderDirTree();
        renderFileTable(currentRootPath);
      });
    }

    if (previewAutoToggle) {
      previewAutoToggle.addEventListener("change", () => {
        if (!selectedFilePath) return;
        setAutoUpload(directoryTree, selectedFilePath, previewAutoToggle.checked);
        renderDirTree();
        renderPreview(findNodeByPath(directoryTree, selectedFilePath));
        renderFileTable(currentRootPath);
      });
    }

    if (previewUploadBtn) {
      previewUploadBtn.addEventListener("click", () => {
        const current = findNodeByPath(directoryTree, selectedFilePath);
        if (!current || current.type !== "file") return;
        const now = new Date().toTimeString().slice(0, 8);
        previewMeta.textContent = `大小 ${current.size} · 更新 ${fmt(current.updated)} · 手动上传 ${fmt(now)}`;
      });
    }

    const files = [
      { name: "app-2024-12-26.log", path: "/data/logs/app/app-2024-12-26.log", size: "14.2 MB", status: "uploaded", time: "10:32:10", autoUpload: true },
      { name: "etl-raw-2024-12-26-01.csv", path: "/data/etl/raw/etl-raw-2024-12-26-01.csv", size: "8.6 MB", status: "uploaded", time: "10:31:58", autoUpload: true },
      { name: "heap-2024-12-26.hprof", path: "/data/logs/app/heap-2024-12-26.hprof", size: "1.2 GB", status: "queued", time: "10:31:45", autoUpload: false },
      { name: "vid-2301.mp4", path: "/data/logs/app/vid-2301.mp4", size: "92 MB", status: "failed", time: "10:31:12", autoUpload: false },
      { name: "error-2024-12-26.tar.gz", path: "/data/etl/raw/error-2024-12-26.tar.gz", size: "380 MB", status: "queued", time: "10:30:02", autoUpload: false },
      { name: "model-v12.zip", path: "/data/logs/app/model-v12.zip", size: "482 MB", status: "uploaded", time: "10:30:44", autoUpload: true }
    ];

    const tailLines = [
      "[10:32:10] upload success key=logs/2024/12/26/app.log size=14.2MB latency=640ms",
      "[10:31:58] enqueue raw csv -> bucket=logs-warm",
      "[10:31:50] auto-upload disabled for /data/logs/app/heap-2024-12-26.hprof (manual review)",
      "[10:31:45] heap dump queued for quarantine size>1GB",
      "[10:31:12] upload failed key=vid-2301.mp4 err=timeout",
      "[10:30:44] uploaded model-v12.zip latency=2.4s route=artifacts",
      "[10:30:31] gc-2024-12-26.txt uploaded latency=530ms",
      "[10:30:02] throttled full-2024-12-26.tar.gz queue=high"
    ];

    const timelineEvents = [
      { label: "检测新文件", time: "10:31:45", status: "info" },
      { label: "静默窗口通过", time: "10:31:48", status: "success" },
      { label: "路由：隔离", time: "10:31:50", status: "warning" },
      { label: "等待审批", time: "10:31:55", status: "danger" }
    ];

    const failures = [
      { file: "vid-2301.mp4", reason: "S3 超时", attempts: 2, next: "1m 后重试" },
      { file: "2024-12-25-23.csv", reason: "MD5 不一致", attempts: 1, next: "排队" },
      { file: "heap-2024-12-26.hprof", reason: "超阈值需审批", attempts: 0, next: "待审核" }
    ];

    const routes = [
      { name: "日志目录直传", cond: "path startsWith /data/logs/app", action: "直传 s3://logs-warm + Webhook" },
      { name: "ETL 原始同步", cond: "path startsWith /data/etl/raw", action: "直传 s3://etl-raw + 校验" },
      { name: "大文件隔离", cond: "size > 1GB 或 autoUpload=关闭", action: "断点续传 + 审批" }
    ];

    const fileTable = document.getElementById("fileTable");
    const renderFileTable = (rootPath) => {
      if (!fileTable) return;
      const filtered = files.filter((f) => rootPath ? f.path.startsWith(rootPath) : true);
      fileTable.innerHTML = `
        <thead><tr><th>文件</th><th>大小</th><th>自动上传</th><th>状态</th><th>更新时间</th><th>操作</th></tr></thead>
        <tbody>
          ${filtered.map(f => `
            <tr>
              <td>
                <div style="font-weight:600;">${f.name}</div>
                <div style="color:${'var(--muted)'}; font-size:12px;">${f.path}</div>
              </td>
              <td>${f.size}</td>
              <td><span class="pill ${f.autoUpload ? 'success' : 'warning'}">${f.autoUpload ? '开启' : '关闭'}</span></td>
              <td><span class="badge">${f.status === 'uploaded' ? '已上传' : f.status === 'queued' ? '队列中' : '失败'}</span></td>
              <td>${fmt(f.time)}</td>
              <td>
                <div class="toolbar" style="gap:6px; margin:0;">
                  <button class="btn secondary" style="padding:6px 8px;">查看</button>
                  <button class="btn secondary" style="padding:6px 8px;">下载</button>
                  <button class="btn secondary" style="padding:6px 8px;">删除</button>
                </div>
              </td>
            </tr>
          `).join('')}
        </tbody>
      `;
    };
    renderFileTable(currentRootPath);

    document.getElementById("tailBox").innerText = tailLines.join("\n");

    const timelineBox = document.getElementById("timeline");
    timelineBox.innerHTML = timelineEvents.map(ev => `
      <div class="timeline-item">
        <span class="pill ${ev.status === 'success' ? 'success' : ev.status === 'warning' ? 'warning' : ev.status === 'danger' ? 'danger' : 'info'}">${ev.label}</span>
        <div style="color:var(--muted); font-size:12px;">${fmt(ev.time)}</div>
        <div style="color:var(--muted); font-size:12px; text-align:right;">srv-01</div>
      </div>
    `).join('');

    const failureTable = document.getElementById("failureTable");
    failureTable.innerHTML = `
      <thead><tr><th>文件</th><th>原因</th><th>尝试</th><th>下一步</th><th></th></tr></thead>
      <tbody>
        ${failures.map(f => `
          <tr>
            <td>${f.file}</td>
            <td><span class="badge">${f.reason}</span></td>
            <td>${f.attempts}x</td>
            <td>${f.next}</td>
            <td><button class="btn secondary" style="padding:6px 10px;">重试</button></td>
          </tr>
        `).join('')}
      </tbody>
    `;

    const routePreview = document.getElementById("routePreview");
    routePreview.innerHTML = routes.map(r => `
      <div class="stack-item">
        <strong>${r.name}</strong>
        <div class="meta" style="color:var(--text); font-size:13px;">When: ${r.cond}</div>
        <div class="meta" style="color:var(--text); font-size:13px;">Action: ${r.action}</div>
      </div>
    `).join('');

    const ctx = document.getElementById("throughputChart").getContext("2d");
    new Chart(ctx, {
      type: "line",
      data: {
        labels: ["02:00", "04:00", "06:00", "08:00", "10:00", "12:00"],
        datasets: [
          { label: "Uploads", data: [40, 52, 60, 78, 92, 88], borderColor: "#22d3ee", backgroundColor: "rgba(34,211,238,0.12)", fill: true, tension: 0.35, pointRadius: 0 },
          { label: "Failures", data: [2, 1, 3, 4, 2, 3], borderColor: "#f43f5e", backgroundColor: "rgba(244,63,94,0.10)", fill: true, tension: 0.35, pointRadius: 0 },
          { label: "Queue", data: [20, 34, 40, 52, 38, 32], borderColor: "#f59e0b", backgroundColor: "rgba(245,158,11,0.08)", fill: true, tension: 0.35, pointRadius: 0 }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { labels: { color: "#e5e7eb" } }, tooltip: { intersect: false, mode: "index" } },
        scales: { x: { grid: { color: "rgba(255,255,255,0.06)" }, ticks: { color: "#9ca3af" } }, y: { grid: { color: "rgba(255,255,255,0.06)" }, ticks: { color: "#9ca3af" } } }
      }
    });
  </script>
</body>
</html>
