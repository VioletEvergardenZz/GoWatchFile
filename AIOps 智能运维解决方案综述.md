# GWF 平台化演进蓝图（面向运维事件分析与知识决策）

> 文档状态：历史背景（兼容保留）  
> 校准日期：2026-02-22
> 口径说明：历史材料用于追溯，不作为当前主线能力定义依据。

> 适用范围：`go-watch-file` + `console-frontend` 当前项目。  
> 目标：在不推翻现有可用能力的前提下，按“先稳、再控、后编排、再智能”的路径，渐进演化为可复用、可扩展、可治理的平台。

---

## 1. 执行摘要（你当前所处阶段）

### 1.1 当前能力（已具备）
- Agent：目录监听、静默窗口、并发上传、失败重试、可选队列持久化。
- 控制台：仪表盘、目录树、手动上传、Tail/检索、告警控制台、系统资源面板。
- 告警：规则匹配、抑制、升级、通知（钉钉/邮件）。
- AI：可选日志总结。

### 1.2 当前关键约束
- 状态以运行时内存为中心，持久化程度不足。
- 无多 Agent 控制面（注册、心跳、分组、灰度配置）。
- 无统一任务模型（上传只是动作之一，路由与编排尚未产品化）。
- 缺少平台级统一指标与 SLO 门禁。

### 1.3 演进总目标（12~18 个月）
将系统从“单机可用工具”演进为“多 Agent 运维事件分析与知识决策平台”：
1. **可运营**：稳定、可观测、可恢复。
2. **可治理**：多租户、多团队、审计、权限。
3. **可编排**：路由规则、动作编排、失败补偿。
4. **可智能**：异常检测、根因关联、策略推荐。

### 1.4 当前阶段决策（已确认）
- **决策 1：AI 是主线能力，不再归类为“后续可选”**。  
  当前阶段必须保障 AI 日志分析与告警 AI 分析在生产可控范围内可用。
- **决策 2：优先做“可观测 + 可回滚”再做“全自动化”**。  
  自动处置仅在低风险场景灰度开启，必须绑定审批与回滚机制。
- **决策 3：输入侧采用可插拔策略**。  
  文件监控上传保留为默认输入适配器，并逐步支持其他事件输入。
- **决策 4：阶段执行采用双主线并行**。  
  一条线稳输入链路可靠性与控制面基础，一条线做 AIOps 数据质量与分析闭环。

### 1.5 定位口径说明
- 平台定位：运维事件分析与知识决策平台。
- 文件监控上传定位：输入适配器之一，按业务用量投入。
- 后续可根据新需求调整输入源优先级。

---

## 2. 平台化原则（防止中途失控）

- **兼容优先**：现有 API 与前端行为先保持兼容，新增能力通过新版本接口扩展。
- **最小可行闭环**：每个阶段必须形成“采集-处理-可视化-告警-回滚”闭环再进入下一阶段。
- **分层解耦**：数据面（Agent 执行）与控制面（配置/调度/治理）分离。
- **事件驱动**：用统一事件模型串联上传、处理、告警、通知，减少耦合调用。
- **可插拔扩展**：存储、通知、Action 执行器、AI 引擎均采用 Adapter/Plugin 方式。
- **治理先于智能**：数据质量、标准字段、审计完备后再扩大 AI 自动化范围。

---

## 3. 目标架构（渐进式，不一次重构）

## 3.1 两大平面

### 数据平面（Data Plane）
部署在业务节点，负责：
- 文件监听与采集
- 上传与本地可靠队列
- 本地动作执行（可选）
- 指标与心跳上报

### 控制平面（Control Plane）
集中服务，负责：
- Agent 注册、分组、配置下发
- 任务编排、路由决策、重试补偿
- 元数据存储、检索、审计
- 统一告警、报表、SLA 评估

## 3.2 目标模块（按可迭代拆分）

1. **Agent Runtime**（保留现有 `go-watch-file` 内核）
2. **Control API**（新增统一控制接口）
3. **Scheduler / Orchestrator**（任务编排器）
4. **Metadata Store**（file_events / tasks / agents / rules）
5. **Rule Engine**（路由 + 告警 + 抑制策略）
6. **Notification Hub**（邮件/钉钉/Webhook）
7. **Portal Console**（前端控制台升级）
8. **AI Assist Service**（总结、异常归因、建议）

---

## 4. 分阶段演进路线（阶段目标 + 退出标准）

## 阶段 0：基线固化（2~4 周）
**目标**：把“能跑”变成“可回归验证”。

**建设项**
- 补齐基础测试：watcher/upload/pathutil/API 核心路径。
- 补齐运行指标：队列长度、上传耗时、失败原因、重试次数、queue full 次数。
- 统一日志结构（建议 JSON 可切换）。
- 建立环境基线：dev/stage/prod 配置模板。

**退出标准（DoD）**
- `go test ./...` 稳定通过。
- 有最小压测报告（例如 1w 文件、3 种大小梯度）。
- 能输出“上传成功率 / 平均耗时 / 失败 TopN”日报。

---

## 阶段 1：可靠性增强（4~6 周）
**目标**：从“尽力上传”变“可恢复上传”。

**建设项**
- 重试策略增强：指数退避 + 最大重试上限 + 错误分类。
- 队列策略：高水位告警、限流、熔断（避免雪崩）。
- 大文件策略 V1：ETag 校验、分段上传预留接口。
- 健康探针扩展：ready/live 区分，附带 degrade 状态。

**退出标准（DoD）**
- 重启恢复后队列无重复失控（幂等策略有效）。
- 出现下游 OSS 抖动时，系统可降级并告警，不致阻塞全链路。

---

## 阶段 2：控制面 MVP（6~8 周）
**目标**：支持多 Agent 管理。

**建设项**
- Agent 注册/心跳 API。
- Agent 分组（环境、业务线、机房、标签）。
- 配置中心（拉模式优先，推模式后补）。
- Agent 状态面板（在线率、版本、最近错误）。
- 基础审计（谁改了什么配置，何时生效）。

**退出标准（DoD）**
- 同时管理 >= 20 Agent（可先实验环境）。
- 配置变更可追溯、可回滚。
- 离线 Agent 在控制台可视化并告警。

---

## 阶段 3：路由与编排（8~12 周）
**目标**：让平台从“上传工具”升级为“任务平台”。

**建设项**
- 统一 Task 模型：`UPLOAD`、`WEBHOOK`、`SCRIPT`、`ARCHIVE`。
- Rule Engine：按路径/后缀/大小/标签/时间窗口路由。
- 编排能力：串行、并行、超时、取消、重试、补偿。
- 幂等键策略：`file_hash` 或 `path+mtime+size`。
- 失败处理：死信队列（DLQ）与人工重放。

**退出标准（DoD）**
- 至少 3 条真实业务流（如日志归档流、故障转储流、审计文件流）在平台配置实现。
- 任务失败可重试/可补偿/可审计。

---

## 阶段 4：存储索引与报表（6~8 周）
**目标**：从“只看最近状态”升级为“可历史分析”。

**建设项**
- 元数据落库：`agents`, `file_sources`, `file_events`, `tasks`, `notifications`, `routing_rules`。
- 查询 API：按时间、状态、来源、业务标签检索。
- 报表中心：上传量、失败率、滞留数、吞吐、容量趋势。
- SLA/SLO：定义与自动计算（日/周/月）。

**退出标准（DoD）**
- 任意文件可追踪完整生命周期（采集→上传→任务→通知）。
- SLA 面板可看到达成率与违规明细。

---

## 阶段 5：AIOps 增强（持续迭代）
**目标**：从可视化运营升级为智能运营。

**建设项**
- 异常检测：上传失败率突增、滞留增长异常、吞吐异常波动。
- 根因关联：结合变更记录、Agent 版本、下游错误码。
- 策略推荐：给出“建议动作 + 风险级别 + 回滚方案”。
- 自动化闭环（灰度开启）：低风险场景自动执行（如重试策略切换）。

**退出标准（DoD）**
- MTTD / MTTR 有可量化改善。
- 自动化动作有审批和回滚保护。

---

## 5. 未来 90 天执行计划（按周）

> 优先级口径：`P0 稳定性与观测` > `P1 控制面 MVP` > `P2 路由与智能增强`。

## 冲刺 1-2（第 1~2 周）：基线与观测
- 建立平台指标清单（必须项 + 可选项）。
- 实现指标采集与暴露（Prometheus 兼容）。
- 新增健康页字段：队列水位、重试分布、失败分类。
- 建立“回归清单”脚本与 CI 基础门禁。
- 建立 AI 结果质量基线（固定样例回放 + 结构校验 + 超时统计）。

**交付物**
- 指标字典 v1
- 健康检查增强版
- 测试与压测最小脚本

## 冲刺 3-4（第 3~4 周）：可靠性增强
- 实装指数退避与最大重试上限。
- 错误分类（网络错误、权限错误、对象存在冲突等）。
- 队列高水位告警与入队限流。
- 补充失败补偿接口（人工重放入口）。
- 补充 AI 降级策略（超时重试、输入压缩、失败可观测）。

**交付物**
- 重试策略 v2
- 队列保护机制 v1
- 失败重放 API（单任务）

## 冲刺 5-6（第 5~6 周）：控制面数据模型
- 设计并落地基础表结构（先最小字段）。
- 新增 `agents` 与 `file_events` 写入链路。
- 引入配置版本号与变更审计记录。
- 后端保留兼容模式：无 DB 时回退内存态。

**交付物**
- 数据库 schema v1
- 事件写库管道
- 审计日志 v1

## 冲刺 7-8（第 7~8 周）：多 Agent MVP
- Agent 注册/心跳 API。
- Agent 分组 + 标签管理。
- 控制台新增 Agent 列表页与状态页。
- 离线告警与升级通知策略。

**交付物**
- Agent 管理 API v1
- Agent 控制台 v1
- 离线告警规则 v1

## 冲刺 9-10（第 9~10 周）：任务模型与路由基础
- 引入统一 Task 模型与状态机。
- 支持 2 类 Action（上传/HTTP Webhook）。
- 路由规则引擎 v1（后缀 + 路径 + 标签）。
- 任务追踪页（单文件视角）。

**交付物**
- 任务 API v1
- 规则引擎 v1
- 生命周期追踪页 v1

## 冲刺 11-12（第 11~12 周）：验收与发布
- 压测、故障演练、回滚演练。
- 输出运维运行手册与升级指南。
- 输出阶段复盘（目标达成、技术债、下阶段计划）。
- 输出 AIOps 质量复盘（误报/漏报样例、建议采纳率、人工干预占比）。

**交付物**
- 阶段验收报告
- 运维手册 v1
- Q2 演进计划

---

## 6. API 演进策略（兼容 + 扩展）

## 6.1 现有接口保留（兼容层）
- 保持 `/api/dashboard`、`/api/manual-upload`、`/api/config` 等现有接口可用。
- 前端默认继续轮询模式，不立即切换通信协议。

## 6.2 新增平台接口（逐步引入）

### Agent 控制面
- `POST /api/v1/agents/register`
- `POST /api/v1/agents/heartbeat`
- `GET /api/v1/agents`
- `POST /api/v1/agents/{id}/config`

### 任务与事件
- `POST /api/v1/tasks`
- `GET /api/v1/tasks`
- `POST /api/v1/tasks/{id}:retry`
- `POST /api/v1/tasks/{id}:cancel`
- `GET /api/v1/file-events`

### 规则与编排
- `GET /api/v1/rules`
- `POST /api/v1/rules`
- `POST /api/v1/rules/{id}:publish`

## 6.3 版本策略
- `/api/*` 保持当前版本行为（legacy）。
- 新增能力统一走 `/api/v1/*`。
- 重大变更通过 `x-api-version` 或路径版本控制。

---

## 7. 数据模型演进（最小可扩展）

## 7.1 最小核心表（先建）
- `agents`
- `file_events`
- `tasks`
- `task_attempts`
- `routing_rules`
- `notifications`
- `audit_logs`

## 7.2 关键字段建议

### `agents`
- `id`, `hostname`, `ip`, `version`, `status`, `labels`, `last_heartbeat_at`

### `file_events`
- `id`, `agent_id`, `source_path`, `file_name`, `size`, `hash`, `event_type`, `occurred_at`

### `tasks`
- `id`, `file_event_id`, `task_type`, `status`, `retry_count`, `max_retries`, `next_run_at`, `result`

### `routing_rules`
- `id`, `name`, `priority`, `matcher`, `action`, `enabled`, `version`

### `audit_logs`
- `id`, `operator`, `action`, `resource_type`, `resource_id`, `diff`, `created_at`

---

## 8. 可扩展能力契约（关键）

## 8.1 Action 执行器插件契约
统一定义：
- `Validate(config)`
- `Execute(taskCtx)`
- `Compensate(taskCtx)`（可选）
- `Describe()`

首批实现：
- `UploadAction`
- `WebhookAction`
- `ScriptAction`（受控白名单）

## 8.2 通知通道插件契约
统一定义：
- `Send(message, severity, metadata)`
- `HealthCheck()`

首批实现：
- DingTalk
- Email
- Webhook（可扩展到企业微信/Slack）

## 8.3 存储适配器契约
统一定义：
- `PutObject`
- `GetObjectMeta`
- `MultipartUpload`
- `VerifyChecksum`

首批实现：
- 阿里云 OSS（现有）
- 后续可扩展 MinIO/COS/OSS 专项优化

---

## 9. 前端平台化演进（console-frontend）

## 9.1 信息架构重构（分三层）
1. **运行态层**：现有 dashboard/tail/alerts（保留）
2. **控制面层**：Agent 管理、规则管理、任务编排
3. **治理层**：审计中心、SLA 报表、策略版本

## 9.2 UI 渐进策略
- 先新增“Agent 中心”页，不动原页面主流程。
- 再新增“任务追踪”页，复用现有上传记录组件样式。
- 最后增加“规则中心”和“审计中心”，形成平台门户。

---

## 10. SLO/KPI 与阶段门禁

## 10.1 稳定性
- 上传成功率 >= 99.9%（按文件数）
- 任务最终成功率 >= 99.5%（含重试）
- 控制面 API 可用性 >= 99.95%

## 10.2 效率
- 队列滞留 P95 < 5 分钟
- 告警误报率逐季度下降
- 人工干预次数逐季度下降

## 10.3 运营
- Agent 在线率 >= 99%
- 规则复用率持续提升
- 复盘闭环率（有问题单、有根因、有改进项）>= 95%

---

## 11. 组织与流程建议（确保长期演进）

- 设立小型平台小组：后端 2、前端 1、测试/运维 1（可兼职）。
- 双周迭代，月度里程碑，季度复盘。
- 所有高风险能力（自动化动作）必须绑定审批流与回滚脚本。
- 对每个阶段保留“技术债清单”，避免只堆功能。

---

## 12. 风险清单与应对

- **风险：过早追求复杂编排**  
  应对：先落地 2~3 条高价值标准流，再扩展 DSL。

- **风险：多 Agent 后运维复杂度上升**  
  应对：先做标签与分组治理，再做全量自动下发。

- **风险：数据质量不足导致 AI 误导**  
  应对：先建设统一事件模型与字段质量检查。

- **风险：平台改造影响现网稳定**  
  应对：灰度发布 + 双写验证 + 回退开关。

---

## 13. 你可以马上开工的“第一批任务”（本周）

1. 明确并发布指标字典 v1（后端 + 前端统一口径）。
2. 在后端新增 `/api/v1/agents/register` 与 `/api/v1/agents/heartbeat` 占位接口（可先内存实现）。
3. 建立 `agents`、`file_events` 两张最小表并接入写入链路（可先 SQLite）。
4. 前端新增“Agent 中心”空页面与接口调用骨架。
5. 输出《阶段 0 验收清单》并在 CI 加基础门禁。

---

## 14. 结论

本项目最优路径不是“大改重构”，而是按阶段逐步演化：
- **短期**：可靠性与观测先到位；
- **中期**：控制面与多 Agent 管理成型；
- **长期**：路由编排 + AIOps 智能化形成平台壁垒。

这条路线既能保证当前业务连续性，也能持续累积为真正的平台资产。

